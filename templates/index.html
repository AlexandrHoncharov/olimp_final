{% extends "base.html" %}

{% block title %}Главная - Система олимпиад{% endblock %}

{% block content %}
<div class="flex flex-col items-center">
    <h1 class="text-3xl font-bold mb-8 text-center">Добро пожаловать в систему олимпиад</h1>

    {% if current_user.is_authenticated %}
        <div class="w-full max-w-4xl">
            {% if current_user.is_admin %}
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Олимпиады</h2>
                    <button
                        id="create-olympiad-button"
                        onclick="showCreateOlympiadModal()"
                        class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
                    >
                        Создать олимпиаду
                    </button>
                </div>
            {% else %}
                <h2 class="text-2xl font-semibold mb-6">Доступные олимпиады</h2>
            {% endif %}

            {% if olympiads %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for olympiad in olympiads %}
                        <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition">
                            <h3 class="text-xl font-semibold mb-2">{{ olympiad.title }}</h3>
                            <p class="text-gray-600 mb-4 line-clamp-3">{{ olympiad.description }}</p>
                            <div class="text-sm text-gray-500 mb-4">
                                <div>Начало: {{ olympiad.start_time.strftime('%d.%m.%Y %H:%M') }}</div>
                                <div>Окончание: {{ olympiad.end_time.strftime('%d.%m.%Y %H:%M') }}</div>
                            </div>
                            <a
                                href="{{ url_for('view_olympiad', olympiad_id=olympiad.id) }}"
                                class="inline-block px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
                            >
                                Подробнее
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="bg-white p-8 rounded-lg shadow-md text-center">
                    <p class="text-xl text-gray-600">Нет доступных олимпиад</p>
                    {% if current_user.is_admin %}
                        <button
                            onclick="showCreateOlympiadModal()"
                            class="mt-4 px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
                        >
                            Создать олимпиаду
                        </button>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="max-w-2xl text-center">
            <p class="text-lg mb-6">Платформа для проведения онлайн-олимпиад с возможностью создания разнообразных заданий и автоматической оценкой результатов.</p>
            <div class="flex justify-center space-x-4">
                <a href="{{ url_for('login') }}" class="px-6 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition">Войти</a>
                <a href="{{ url_for('register') }}" class="px-6 py-3 bg-white border border-primary text-primary rounded hover:bg-gray-50 transition">Зарегистрироваться</a>
            </div>
        </div>
    {% endif %}
</div>

{% if current_user.is_authenticated and current_user.is_admin %}
    <!-- Модальное окно для создания олимпиады -->
    <div id="create-olympiad-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">Создание новой олимпиады</h3>
                <button onclick="closeCreateOlympiadModal()" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <form id="create-olympiad-form" enctype="multipart/form-data">
                    <div class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Название олимпиады</label>
                            <input type="text" id="title" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                            <textarea id="description" name="description" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="start_time" class="block text-sm font-medium text-gray-700 mb-1">Время начала</label>
                                <input type="datetime-local" id="start_time" name="start_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                            <div>
                                <label for="end_time" class="block text-sm font-medium text-gray-700 mb-1">Время окончания</label>
                                <input type="datetime-local" id="end_time" name="end_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                            </div>
                        </div>
                        <div>
                            <label for="welcome_pdf" class="block text-sm font-medium text-gray-700 mb-1">Приветственный PDF (необязательно)</label>
                            <input type="file" id="welcome_pdf" name="welcome_pdf" accept=".pdf" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                <button onclick="closeCreateOlympiadModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
                <button onclick="submitCreateOlympiadForm()" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Создать</button>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if current_user.is_authenticated and current_user.is_admin %}
<script>
    function showCreateOlympiadModal() {
        const modal = document.getElementById('create-olympiad-modal');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeCreateOlympiadModal() {
        const modal = document.getElementById('create-olympiad-modal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function submitCreateOlympiadForm() {
        const form = document.getElementById('create-olympiad-form');
        const formData = new FormData(form);

        // Отображаем индикатор загрузки
        const submitBtn = event.target;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Создание...';
        submitBtn.disabled = true;

        axios.post('{{ url_for("create_olympiad") }}', formData)
            .then(function(response) {
                if (response.data.success) {
                    showMessage('Олимпиада успешно создана!');
                    setTimeout(() => {
                        window.location.href = '/admin/olympiad/' + response.data.olympiad_id;
                    }, 1000);
                } else {
                    showMessage(response.data.message || 'Ошибка при создании олимпиады', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(function(error) {
                showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
    }

    // Закрытие модального окна по клику вне его области
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('create-olympiad-modal');
        if (modal && !modal.classList.contains('hidden')) {
            const modalContent = modal.querySelector('.bg-white');
            if (event.target === modal && !modalContent.contains(event.target)) {
                closeCreateOlympiadModal();
            }
        }
    });

    // Закрытие модального окна по нажатию Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('create-olympiad-modal');
            if (modal && !modal.classList.contains('hidden')) {
                closeCreateOlympiadModal();
            }
        }
    });
</script>
{% endif %}
{% endblock %}