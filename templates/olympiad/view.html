<!-- olympiad/view.html -->
{% extends "base.html" %}

{% block title %}{{ olympiad.title }} - Система олимпиад{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('index') }}" class="text-primary hover:underline">&larr; Вернуться к списку олимпиад</a>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h1 class="text-3xl font-bold mb-4">{{ olympiad.title }}</h1>

        <div class="flex flex-wrap gap-4 mb-4 text-sm">
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Начало:</span> {{ olympiad.start_time.strftime('%d.%m.%Y %H:%M') }}
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Окончание:</span> {{ olympiad.end_time.strftime('%d.%m.%Y %H:%M') }}
            </div>
        </div>

        <div class="prose max-w-none">
            <p>{{ olympiad.description }}</p>
        </div>

        {% if olympiad.welcome_pdf %}
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3">Приветственное письмо</h2>
                <div class="border rounded">
                    <embed src="{{ url_for('static', filename='pdf_files/' + olympiad.welcome_pdf) }}" type="application/pdf" width="100%" height="600px" />
                </div>
            </div>
        {% endif %}

        <div class="mt-6">
            {% if participation %}
                {% if participation.status == 'registered' %}
                    <button
                        onclick="startOlympiad()"
                        class="px-6 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition"
                    >
                        Начать олимпиаду
                    </button>
                {% elif participation.status == 'in_progress' %}
                    <a
                        href="{{ url_for('take_olympiad', olympiad_id=olympiad.id) }}"
                        class="inline-block px-6 py-3 bg-blue-600 text-white rounded hover:bg-opacity-90 transition"
                    >
                        Продолжить олимпиаду
                    </a>
                {% elif participation.status == 'completed' %}
                    <a
                        href="{{ url_for('olympiad_results', olympiad_id=olympiad.id) }}"
                        class="inline-block px-6 py-3 bg-green-600 text-white rounded hover:bg-opacity-90 transition"
                    >
                        Просмотреть результаты
                    </a>
                {% endif %}
            {% else %}
                <button
                    onclick="registerForOlympiad()"
                    class="px-6 py-3 bg-primary text-white rounded hover:bg-opacity-90 transition"
                >
                    Зарегистрироваться на олимпиаду
                </button>
            {% endif %}

            {% if current_user.is_admin %}
                <a
                    href="{{ url_for('edit_olympiad', olympiad_id=olympiad.id) }}"
                    class="inline-block ml-3 px-6 py-3 bg-gray-600 text-white rounded hover:bg-opacity-90 transition"
                >
                    Редактировать олимпиаду
                </a>
            {% endif %}
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">Информация об олимпиаде</h2>

        <div class="space-y-4">
            <p>Олимпиада состоит из нескольких блоков. Каждый блок содержит различные типы вопросов:</p>
            <ul class="list-disc list-inside space-y-2">
                <li>Тестовые вопросы с одним или несколькими правильными ответами</li>
                <li>Вопросы на сопоставление элементов</li>
            </ul>

            <p>После каждого блока вы увидите свой текущий рейтинг. Для перехода к следующему блоку необходимо набрать установленный процент правильных ответов.</p>

            <p class="font-medium">Начните олимпиаду, когда будете готовы. Удачи!</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function registerForOlympiad() {
        axios.post('{{ url_for("register_olympiad", olympiad_id=olympiad.id) }}')
            .then(function(response) {
                if (response.data.success) {
                    showMessage('Вы успешно зарегистрировались на олимпиаду!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showMessage(response.data.message || 'Ошибка при регистрации', 'error');
                }
            })
            .catch(function(error) {
                showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
            });
    }

    function startOlympiad() {
        axios.post('{{ url_for("start_olympiad", olympiad_id=olympiad.id) }}')
            .then(function(response) {
                if (response.data.success) {
                    if (response.data.redirect) {
                        window.location.href = response.data.redirect;
                    } else {
                        showMessage('Олимпиада успешно начата!');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                } else {
                    showMessage(response.data.message || 'Ошибка при начале олимпиады', 'error');
                }
            })
            .catch(function(error) {
                showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
            });
    }
</script>
{% endblock %}
