{% extends "base.html" %}

{% block title %}Прохождение олимпиады - {{ olympiad.title }}{% endblock %}

{% block head %}
<style>
    /* Base styles */
    .question-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        overflow: hidden;
    }
    .question-card:hover {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .question-card.answered {
        border-left-color: #34d399;
    }
    .question-card.active {
        border-left-color: #770002;
    }

    /* Progress bar */
    .progress-container {
        height: 6px;
        width: 100%;
        background-color: #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #770002 0%, #990002 100%);
        transition: width 0.5s ease;
    }

    /* Drag and drop styles */
    .draggable {
        cursor: grab;
        user-select: none;
        padding: 10px 14px;
        margin-bottom: 8px;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    .draggable:hover {
        background-color: #f3f4f6;
        transform: translateY(-2px);
    }
    .draggable.dragging {
        opacity: 0.8;
        background-color: #dbeafe;
        cursor: grabbing;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .matched-pair {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    .matched-pair .left-item {
        flex: 1;
        min-width: 0;
        padding: 10px 14px;
        background-color: #f3f4f6;
        border-radius: 0.5rem 0 0 0.5rem;
        border: 1px solid #e5e7eb;
        border-right: none;
        font-weight: 500;
    }
    .matched-pair .right-item {
        flex: 1;
        min-width: 0;
        padding: 0;
        border-radius: 0 0.5rem 0.5rem 0;
        background-color: #f8fafc;
        border: 1px solid #e5e7eb;
    }
    .matched-pair .connector {
        padding: 0 8px;
        color: #6b7280;
        display: flex;
        align-items: center;
    }
    .connector-arrow {
        width: 24px;
        height: 24px;
    }

    /* Radio and checkbox styling */
    .custom-radio,
    .custom-checkbox {
        position: relative;
        padding-left: 28px;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: flex-start;
    }
    .custom-radio input,
    .custom-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    .radio-checkmark,
    .checkbox-checkmark {
        position: absolute;
        top: 3px;
        left: 0;
        height: 20px;
        width: 20px;
        background-color: #fff;
        border: 2px solid #d1d5db;
        transition: all 0.2s ease;
    }
    .radio-checkmark {
        border-radius: 50%;
    }
    .checkbox-checkmark {
        border-radius: 4px;
    }
    .custom-radio:hover .radio-checkmark,
    .custom-checkbox:hover .checkbox-checkmark {
        border-color: #9ca3af;
    }
    .custom-radio input:checked ~ .radio-checkmark,
    .custom-checkbox input:checked ~ .checkbox-checkmark {
        background-color: #770002;
        border-color: #770002;
    }
    .radio-checkmark:after,
    .checkbox-checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }
    .custom-radio input:checked ~ .radio-checkmark:after,
    .custom-checkbox input:checked ~ .checkbox-checkmark:after {
        display: block;
    }
    .custom-radio .radio-checkmark:after {
        top: 5px;
        left: 5px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: white;
    }
    .custom-checkbox .checkbox-checkmark:after {
        left: 6px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
    }
    .animate-slideIn {
        animation: slideIn 0.3s ease-out;
    }
    .pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(119, 0, 2, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(119, 0, 2, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(119, 0, 2, 0);
        }
    }

    /* Button effects */
    .btn-action {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .btn-action::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }
    .btn-action:hover::after {
        animation: ripple 1s ease-out;
    }
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(30, 30);
            opacity: 0;
        }
    }

    /* Ranking modal styles */
    .rank-header {
        background: linear-gradient(135deg, #770002 0%, #990002 100%);
        border-radius: 0.5rem 0.5rem 0 0;
    }
    .rank-container {
        text-align: center;
        margin-bottom: 24px;
    }
    .rank-value {
        font-size: 64px;
        font-weight: bold;
        background: linear-gradient(135deg, #770002 0%, #990002 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        line-height: 1;
    }
    .rank-label {
        margin-top: 8px;
        font-size: 16px;
        color: #64748b;
    }
    .rank-progress {
        margin-top: 16px;
        height: 10px;
        background-color: #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
    }
    .rank-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #770002 0%, #990002 100%);
        transition: width 1s ease;
    }

    /* Stats box */
    .stats-box {
        display: flex;
        align-items: center;
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 0.5rem;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
    }
    .stats-icon {
        width: 36px;
        height: 36px;
        margin-right: 12px;
        padding: 8px;
        background-color: #f3f4f6;
        border-radius: 9999px;
    }
    .stats-content {
        flex: 1;
    }
    .stats-label {
        font-size: 14px;
        color: #6b7280;
    }
    .stats-value {
        font-size: 16px;
        font-weight: 600;
    }

    .olympiad-header {
        background: linear-gradient(135deg, #770002 0%, #990002 100%);
        border-radius: 0.5rem 0.5rem 0 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('view_olympiad', olympiad_id=olympiad.id) }}" class="inline-flex items-center text-primary hover:text-primary-dark transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Вернуться к олимпиаде
    </a>
</div>

<div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
    <div class="olympiad-header text-white p-6">
        <h1 class="text-2xl font-bold mb-2">{{ olympiad.title }}</h1>
        <h2 class="text-xl font-medium mb-4">Блок: {{ block.title }}</h2>

        {% if block.description %}
            <p class="mb-4 text-white text-opacity-90">{{ block.description }}</p>
        {% endif %}
    </div>

    <div class="p-6">
        <div class="flex flex-wrap justify-between items-center mb-4">
            <div class="flex items-center mb-3 md:mb-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                <span class="text-gray-600">
                    Начало: {{ participation.start_time.strftime('%d.%m.%Y %H:%M') if participation.start_time else 'Н/Д' }}
                </span>
            </div>

            <div>
                <span class="font-medium mr-2">Прогресс:</span>
                <span id="answer-count" class="font-bold text-primary">{{ user_answers|length }}</span> / <span class="font-bold">{{ questions|length }}</span>
            </div>
        </div>

        <div class="progress-container mb-6">
            <div class="progress-bar" style="width: {{ (user_answers|length / questions|length) * 100 }}%"></div>
        </div>
    </div>
</div>

<div class="space-y-6 mb-8">
    {% for question in questions %}
        <div
            id="question-{{ question.id }}"
            class="question-card bg-white p-6 rounded-lg shadow-md transition {% if question.id in user_answers %}answered{% endif %}"
            data-question-id="{{ question.id }}"
            data-question-type="{{ question.question_type }}"
        >
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold">Вопрос {{ loop.index }}: {{ question.text }}</h3>
                <div id="answer-status-{{ question.id }}" class="answer-status {% if question.id in user_answers %}flex{% else %}hidden{% endif %} items-center text-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-sm">Ответ сохранен</span>
                </div>
            </div>

            <form id="question-form-{{ question.id }}" class="mb-4">
                {% if question.question_type == 'test' %}
                    <div class="space-y-3 mb-6">
                        {% if question.options_list %}
                            {% set isMultiple = question.correct_answers_list|length > 1 %}
                            {% for option in question.options_list %}
                                <label class="custom-{% if isMultiple %}checkbox{% else %}radio{% endif %} block p-3 rounded-lg hover:bg-gray-50 transition">
                                    <input
                                        type="{% if isMultiple %}checkbox{% else %}radio{% endif %}"
                                        name="question-{{ question.id }}"
                                        value="{{ option }}"
                                        class="answer-input"
                                        {% if question.id in user_answers and option in user_answers[question.id] %}checked{% endif %}
                                    >
                                    <span class="{% if isMultiple %}checkbox{% else %}radio{% endif %}-checkmark"></span>
                                    <span class="ml-2">{{ option }}</span>
                                </label>
                            {% endfor %}
                        {% else %}
                            <p class="text-red-500">Ошибка: не удалось загрузить варианты ответов</p>
                        {% endif %}
                    </div>
                {% elif question.question_type == 'matching' %}
                    <div class="matching-container" id="matching-container-{{ question.id }}">
                        {% if question.matches_list %}
                            <input type="hidden" id="matching-data-{{ question.id }}" value="{{ question.matches_list|tojson }}">

                            <div class="reorder-container" id="matches-list-{{ question.id }}">
                                {% for match in question.matches_list %}
                                    <div class="matched-pair" id="pair-{{ loop.index }}-{{ question.id }}">
                                        <div class="left-item" data-left="{{ match.left }}">{{ match.left }}</div>
                                        <div class="connector">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="connector-arrow" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="right-item" id="right-container-{{ loop.index }}-{{ question.id }}">
                                            <!-- Сюда будут помещены перемешанные ответы -->
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-red-500">Ошибка: не удалось загрузить пары соответствия</p>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Кнопка для отправки ответа -->
                <button
                    type="button"
                    class="btn-action px-5 py-2.5 bg-primary text-white font-medium rounded-md hover:bg-primary-dark transition shadow-md flex items-center answer-button mt-4 {% if question.id in user_answers %}bg-green-600 hover:bg-green-700{% endif %}"
                    data-question-id="{{ question.id }}"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Ответить
                </button>
            </form>

            <div class="flex justify-between items-center">
                <div class="text-sm bg-gray-100 py-1 px-3 rounded-full">
                    <span class="font-medium">Баллы:</span> {{ question.points }}
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<div class="bg-white p-6 rounded-lg shadow-lg mb-6">
    <div class="flex flex-col sm:flex-row justify-between items-center">
        <div class="mb-4 sm:mb-0">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                </svg>
                <span class="font-medium">Ответов:</span>
                <span id="answers-count" class="ml-2 font-bold text-primary">{{ user_answers|length }}</span> / <span class="font-bold">{{ questions|length }}</span>
            </div>
        </div>
        <button
            id="submit-block-button"
            class="btn-action px-6 py-3 bg-primary text-white font-medium rounded-md hover:bg-primary-dark transition shadow-md flex items-center {% if user_answers|length < questions|length %}opacity-50 cursor-not-allowed{% else %}pulse{% endif %}"
            {% if user_answers|length < questions|length %}disabled{% endif %}
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Завершить блок
        </button>
    </div>
</div>

<!-- Модальное окно с рейтингом -->
<div id="ranking-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 animate-fadeIn">
        <div class="rank-header px-6 py-4 flex justify-between items-center text-white">
            <h3 class="text-xl font-medium">Ваш текущий рейтинг</h3>
            <button onclick="closeRankingModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="p-8">
            <div class="rank-container">
                <div class="rank-value" id="rank-position">0</div>
                <div class="rank-label">Ваше место</div>

                <div class="flex justify-between text-sm text-gray-600 mt-4">
                    <span>0%</span>
                    <span id="rank-percentage">0%</span>
                    <span>100%</span>
                </div>
                <div class="rank-progress">
                    <div class="rank-progress-bar" id="rank-progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="stats-box">
                    <div class="stats-icon text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                        </svg>
                    </div>
                    <div class="stats-content">
                        <div class="stats-label">Баллы за блок</div>
                        <div class="stats-value" id="block-points">0</div>
                    </div>
                </div>

                <div class="stats-box">
                    <div class="stats-icon text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="stats-content">
                        <div class="stats-label">Максимум баллов</div>
                        <div class="stats-value" id="block-max-points">0</div>
                    </div>
                </div>

                <div class="stats-box">
                    <div class="stats-icon text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="stats-content">
                        <div class="stats-label">Всего баллов</div>
                        <div class="stats-value" id="total-points">0</div>
                    </div>
                </div>

                <div class="stats-box">
                    <div class="stats-icon text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                        </svg>
                    </div>
                    <div class="stats-content">
                        <div class="stats-label">Всего участников</div>
                        <div class="stats-value" id="total-participants">0</div>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button
                    id="continue-button"
                    class="btn-action px-6 py-3 bg-primary text-white font-medium rounded-md hover:bg-primary-dark transition shadow-md"
                    onclick="continueAfterRanking()"
                >
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Продолжить олимпиаду
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация
        initMatchingQuestions();
        updateAnswerStatusDisplay();

        // Обработчики для радио и чекбоксов
        document.querySelectorAll('.answer-input').forEach(input => {
            input.addEventListener('change', function() {
                const questionId = this.name.split('-')[1];
                highlightAnswerButton(questionId);
            });
        });

        // Обработчики для кнопок ответа
        document.querySelectorAll('.answer-button').forEach(button => {
            button.addEventListener('click', function() {
                const questionId = this.dataset.questionId;
                submitAnswer(questionId);
            });
        });

        // Обработчик для кнопки завершения блока
        document.getElementById('submit-block-button').addEventListener('click', function() {
            submitBlock();
        });

        // Функция инициализации заданий на сопоставление
        function initMatchingQuestions() {
            document.querySelectorAll('.matching-container').forEach(container => {
                const questionId = container.closest('[data-question-id]').dataset.questionId;
                const matchesDataElement = document.getElementById(`matching-data-${questionId}`);

                if (matchesDataElement) {
                    try {
                        // Получаем данные о парах и перемешиваем правые элементы
                        let matchesData = JSON.parse(matchesDataElement.value);
                        let rightItems = matchesData.map(match => match.right);

                        // Перемешиваем правые элементы
                        shuffleArray(rightItems);

                        // Заполняем правые контейнеры перемешанными элементами
                        matchesData.forEach((match, index) => {
                            const rightContainer = document.getElementById(`right-container-${index+1}-${questionId}`);
                            if (rightContainer) {
                                const dragItem = document.createElement('div');
                                dragItem.className = 'draggable reorder-item';
                                dragItem.draggable = true;
                                dragItem.dataset.value = rightItems[index];
                                dragItem.dataset.position = index + 1;
                                dragItem.dataset.questionId = questionId;
                                dragItem.innerText = rightItems[index];
                                rightContainer.appendChild(dragItem);

                                // Добавляем события для перетаскивания
                                dragItem.addEventListener('dragstart', handleDragStart);
                                dragItem.addEventListener('dragend', handleDragEnd);
                            }
                        });

                        // Добавляем события для области сброса
                        const rightContainers = document.querySelectorAll(`[id^="right-container-"][id$="-${questionId}"]`);
                        rightContainers.forEach(container => {
                            container.addEventListener('dragover', handleDragOver);
                            container.addEventListener('dragleave', handleDragLeave);
                            container.addEventListener('drop', handleDrop);
                        });

                    } catch (error) {
                        console.error('Error initializing matching question:', error);
                    }
                }
            });
        }

        // Функции для обработки drag and drop
        function handleDragStart(e) {
            this.classList.add('dragging');
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');

            // Отмечаем кнопку ответа как требующую нажатия
            const questionId = this.dataset.questionId;
            highlightAnswerButton(questionId);
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            const draggable = document.querySelector('.dragging');
            if (!draggable) return;

            // Получаем текущий элемент в этом контейнере
            const currentItem = this.querySelector('.draggable');
            if (currentItem) {
                // Получаем контейнер перетаскиваемого элемента
                const sourceContainer = draggable.parentElement;

                // Обмениваем элементы местами
                sourceContainer.appendChild(currentItem);
                this.appendChild(draggable);
            }
        }

        // Функция для отправки ответа
        function submitAnswer(questionId) {
            const questionContainer = document.getElementById(`question-${questionId}`);
            const questionType = questionContainer.dataset.questionType;
            let answerData;

            if (questionType === 'matching') {
                // Собираем данные для вопроса на сопоставление
                answerData = [];
                const pairs = questionContainer.querySelectorAll('.matched-pair');

                pairs.forEach(pair => {
                    const leftItem = pair.querySelector('.left-item').dataset.left;
                    const rightItem = pair.querySelector('.draggable');

                    if (rightItem) {
                        answerData.push({
                            left: leftItem,
                            right: rightItem.dataset.value
                        });
                    }
                });

                // Проверяем, что все пары есть
                if (answerData.length < pairs.length) {
                    showMessage('Пожалуйста, завершите все сопоставления', 'error');
                    return;
                }
            } else {
                // Собираем данные для тестового вопроса
                const inputs = questionContainer.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked');

                if (inputs.length === 0) {
                    showMessage('Пожалуйста, выберите вариант ответа', 'error');
                    return;
                }

                answerData = Array.from(inputs).map(input => input.value);
            }

            // Отправляем ответ
            const button = questionContainer.querySelector('.answer-button');
            const originalText = button.textContent;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Сохранение...';
            button.disabled = true;

            axios.post(`{{ url_for("submit_answer", olympiad_id=olympiad.id) }}`, {
                question_id: questionId,
                answer_data: answerData
            })
            .then(response => {
                if (response.data.success) {
                    // Показываем статус сохранения
                    const statusElement = document.getElementById(`answer-status-${questionId}`);
                    statusElement.classList.remove('hidden');
                    statusElement.classList.add('flex', 'animate-fadeIn');

                    // Подсвечиваем вопрос
                    questionContainer.classList.add('answered', 'animate-slideIn');

                    // Обновляем счетчик ответов
                    updateAnswerCount();

                    // Сбрасываем кнопку
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Ответить';
                    button.disabled = false;
                    button.classList.remove('bg-primary', 'hover:bg-primary-dark');
                    button.classList.add('bg-green-600', 'hover:bg-green-700');

                    // Показываем сообщение
                    showMessage('Ответ успешно сохранен!');
                } else {
                    showMessage(response.data.message || 'Ошибка при сохранении ответа', 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // Выделение кнопки ответа при изменении выбора
        function highlightAnswerButton(questionId) {
            const button = document.querySelector(`.answer-button[data-question-id="${questionId}"]`);
            if (button) {
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-primary', 'hover:bg-primary-dark', 'animate-pulse');
                setTimeout(() => {
                    button.classList.remove('animate-pulse');
                }, 1000);
            }
        }

        // Обновление отображения статуса ответов
        function updateAnswerStatusDisplay() {
            {% for q_id in user_answers.keys() %}
                const statusElement{{ q_id }} = document.getElementById('answer-status-{{ q_id }}');
                if (statusElement{{ q_id }}) {
                    statusElement{{ q_id }}.classList.remove('hidden');
                    statusElement{{ q_id }}.classList.add('flex');
                }

                const questionElement{{ q_id }} = document.getElementById('question-{{ q_id }}');
                if (questionElement{{ q_id }}) {
                    questionElement{{ q_id }}.classList.add('answered');
                }

                const answerButton{{ q_id }} = document.querySelector(`.answer-button[data-question-id="{{ q_id }}"]`);
                if (answerButton{{ q_id }}) {
                    answerButton{{ q_id }}.classList.remove('bg-primary', 'hover:bg-primary-dark');
                    answerButton{{ q_id }}.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            {% endfor %}
        }

        // Обновление счетчика ответов
        function updateAnswerCount() {
            const answeredQuestions = document.querySelectorAll('.question-card.answered').length;
            const countElement = document.getElementById('answers-count');
            const headerCountElement = document.getElementById('answer-count');

            if (countElement) {
                countElement.textContent = answeredQuestions;
            }

            if (headerCountElement) {
                headerCountElement.textContent = answeredQuestions;
            }

            // Обновляем прогресс-бар
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${(answeredQuestions / {{ questions|length }}) * 100}%`;
            }

            // Обновляем состояние кнопки завершения блока
            const submitButton = document.getElementById('submit-block-button');
            if (answeredQuestions >= {{ questions|length }}) {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.classList.add('pulse');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.classList.remove('pulse');
            }
        }

        // Функция перемешивания массива
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    });

    // Функция для завершения блока
    function submitBlock() {
        const totalQuestions = {{ questions|length }};
        const answeredQuestions = document.querySelectorAll('.question-card.answered').length;

        if (answeredQuestions < totalQuestions) {
            showMessage(`Пожалуйста, ответьте на все вопросы перед отправкой (${answeredQuestions}/${totalQuestions})`, 'error');
            return;
        }

        const button = document.getElementById('submit-block-button');
        button.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Отправка...';
        button.disabled = true;

        // Обязательно задаем тип данных как JSON
        axios.post('{{ url_for("submit_block", olympiad_id=olympiad.id) }}', {}, {
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log("Response from submit_block:", response.data);
            if (response.data.success) {
                // Получаем рейтинг и показываем модальное окно
                fetchRanking(response.data.redirect);
            } else {
                showMessage(response.data.message || 'Ошибка при отправке блока', 'error');
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Завершить блок';
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error("Error in submit_block:", error);
            showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Завершить блок';
            button.disabled = false;
        });
    }

    // Функция для отладки значений рейтинга
    function debugRanking(data) {
        console.log("=== ОТЛАДКА РЕЙТИНГА ===");
        console.log("Место в рейтинге:", data.rank_position);
        console.log("Баллы за текущий блок:", data.block_points);
        console.log("Максимум баллов за блок:", data.block_max_points);
        console.log("Всего баллов:", data.total_points);
        console.log("Всего участников:", data.total_participants);
        console.log("Процент рейтинга:", data.rank_percentage);
        console.log("========================");
    }

    // Функция для получения рейтинга
    function fetchRanking(redirectUrl) {
        console.log("Fetching ranking, redirect URL:", redirectUrl);

        // Добавляем временную метку для предотвращения кэширования
        const timestamp = new Date().getTime();
        axios.get(`{{ url_for("get_ranking", olympiad_id=olympiad.id) }}?t=${timestamp}`)
            .then(response => {
                console.log("Ranking response:", response.data);
                if (response.data.success) {
                    // Отладка полученных значений
                    debugRanking(response.data);

                    // Заполняем данные в модальном окне
                    document.getElementById('rank-position').textContent = response.data.rank_position || "-";

                    // Проверяем процент рейтинга для корректного отображения
                    let rankPercentage = response.data.rank_percentage;
                    if (isNaN(rankPercentage) || rankPercentage < 0) rankPercentage = 0;
                    if (rankPercentage > 100) rankPercentage = 100;

                    document.getElementById('rank-percentage').textContent = rankPercentage + '%';

                    // Анимируем прогресс-бар с задержкой
                    setTimeout(() => {
                        document.getElementById('rank-progress-bar').style.width = rankPercentage + '%';
                    }, 300);

                    // Устанавливаем баллы за блок
                    document.getElementById('block-points').textContent = response.data.block_points;
                    document.getElementById('block-max-points').textContent = response.data.block_max_points;

                    // Устанавливаем общие баллы и участников
                    document.getElementById('total-points').textContent = response.data.total_points;
                    document.getElementById('total-participants').textContent = response.data.total_participants;

                    // Устанавливаем URL для редиректа
                    const continueButton = document.getElementById('continue-button');
                    continueButton.dataset.redirect = redirectUrl;

                    // Показываем модальное окно
                    showRankingModal();
                } else {
                    console.error("Error in ranking response:", response.data.message);
                    // Если не удалось получить рейтинг, просто переходим дальше
                    window.location.href = redirectUrl;
                }
            })
            .catch(error => {
                console.error("Error fetching ranking:", error);
                // В случае ошибки просто переходим дальше
                window.location.href = redirectUrl;
            });
    }

    // Показать модальное окно с рейтингом
    function showRankingModal() {
        console.log("Showing ranking modal");
        const modal = document.getElementById('ranking-modal');
        if (!modal) {
            console.error("Modal element not found!");
            return;
        }
        modal.style.display = 'flex';
        document.body.classList.add('overflow-hidden');
    }

    // Закрыть модальное окно с рейтингом
    function closeRankingModal() {
        const modal = document.getElementById('ranking-modal');
        if (!modal) return;
        modal.style.display = 'none';
        document.body.classList.remove('overflow-hidden');
    }

    // Функция для продолжения после просмотра рейтинга
    function continueAfterRanking() {
        const redirectUrl = document.getElementById('continue-button').dataset.redirect;
        if (redirectUrl) {
            window.location.href = redirectUrl;
        } else {
            closeRankingModal();
        }
    }

    // Глобальные функции
    window.closeRankingModal = closeRankingModal;
    window.continueAfterRanking = continueAfterRanking;
</script>
{% endblock %}