{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–ª–∏–º–ø–∏–∞–¥—ã - {{ olympiad.title }}{% endblock %}

{% block head %}
<style>
    /* –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .question-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .question-card.answered {
        border-left: 4px solid #10b981;
        background-color: #f0fdf4;
    }

    .timer-container {
        background: #dc2626;
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 10px;
    }

    .timer-display {
        font-size: 1.5rem;
        font-weight: bold;
        font-family: monospace;
    }

    .timer-label {
        font-size: 0.875rem;
        margin-bottom: 5px;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-fill {
        height: 100%;
        background-color: #dc2626;
        transition: width 0.3s ease;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è */
    .matching-grid {
        display: grid;
        gap: 20px;
        margin-top: 20px;
    }

    .matching-grid.two-column {
        grid-template-columns: 1fr auto 1fr;
    }

    .matching-grid.three-column {
        grid-template-columns: 1fr auto 1fr auto 1fr;
    }

    .matching-column {
        background: #f9fafb;
        border: 2px solid #d1d5db;
        border-radius: 12px;
        padding: 20px;
        min-height: 250px;
    }

    .matching-column.left {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    .matching-column.middle {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    }

    .matching-column.right {
        border-color: #10b981;
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    }

    .matching-column h4 {
        margin: 0 0 15px 0;
        font-weight: 600;
        font-size: 1rem;
        padding-bottom: 8px;
        border-bottom: 2px solid;
    }

    .matching-column.left h4 {
        color: #1d4ed8;
        border-color: #3b82f6;
    }
    .matching-column.middle h4 {
        color: #d97706;
        border-color: #f59e0b;
    }
    .matching-column.right h4 {
        color: #059669;
        border-color: #10b981;
    }

    .matching-item {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        min-height: 50px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
    }

    .matching-item:hover {
        border-color: #9ca3af;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }

    .matching-item.left-item {
        background: white;
        border-color: #3b82f6;
        font-weight: 600;
        color: #1e40af;
        cursor: default;
        min-height: 80px;
        flex-direction: column;
        align-items: flex-start;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
    }

    .matching-item.middle-item {
        border-color: #f59e0b;
        color: #d97706;
        cursor: grab;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        font-weight: 500;
    }

    .matching-item.right-item {
        border-color: #10b981;
        color: #059669;
        cursor: grab;
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        font-weight: 500;
    }

    .matching-item.dragging {
        opacity: 0.7;
        transform: scale(1.05) rotate(2deg);
        z-index: 1000;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .matching-item.used {
        opacity: 0.5;
        border-style: dashed;
        background: #f3f4f6 !important;
        color: #9ca3af !important;
        cursor: not-allowed;
    }

    .matching-item.used::after {
        content: "‚úì";
        position: absolute;
        top: 4px;
        right: 8px;
        color: #10b981;
        font-weight: bold;
        font-size: 16px;
    }

    .drop-zone-container {
        margin-top: 12px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .drop-zone-slot {
        min-height: 48px;
        border: 2px dashed #9ca3af;
        border-radius: 8px;
        background: #f9fafb;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-size: 0.875rem;
        padding: 12px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
    }

    .drop-zone-slot.middle-slot {
        border-color: #f59e0b;
        background: #fffbeb;
        color: #d97706;
    }

    .drop-zone-slot.right-slot {
        border-color: #10b981;
        background: #ecfdf5;
        color: #059669;
    }

    .drop-zone-slot.drag-over {
        border-style: solid;
        background: #e5e7eb;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .drop-zone-slot.filled {
        border-style: solid;
        background: white;
        color: #374151;
        font-weight: 500;
        padding: 8px 12px;
    }

    /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤ —Å–ª–æ—Ç–µ */
    .remove-button {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 22px;
        height: 22px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .drop-zone-slot.filled:hover .remove-button {
        display: flex;
    }

    .remove-button:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .matching-connector {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px 0;
    }

    .connector-icon {
        width: 32px;
        height: 32px;
        color: #6b7280;
        background: white;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        padding: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ä–∞–¥–∏–æ –∏ —á–µ–∫–±–æ–∫—Å—ã */
    .answer-option {
        display: block;
        padding: 12px 15px;
        margin-bottom: 8px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .answer-option:hover {
        border-color: #9ca3af;
        background: #f9fafb;
    }

    .answer-option input {
        margin-right: 10px;
    }

    .answer-option input:checked + span {
        font-weight: 600;
        color: #dc2626;
    }

    .answer-option:has(input:checked) {
        border-color: #dc2626;
        background: #fef2f2;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: #dc2626;
        color: white;
    }

    .btn-primary:hover {
        background: #b91c1c;
    }

    .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ */
    .info-block {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .info-block.success {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #166534;
    }

    .info-block.info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
    }

    .info-block.warning {
        background: #fffbeb;
        border: 1px solid #fed7aa;
        color: #92400e;
    }

    .info-block.error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        background: #dc2626;
        color: white;
        padding: 15px 20px;
        margin: -20px -20px 20px -20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ */
    .ranking-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid rgba(220, 38, 38, 0.1);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .ranking-card h3 {
        color: #dc2626;
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 16px;
        text-align: center;
    }

    .rank-display {
        text-align: center;
        margin-bottom: 20px;
    }

    .rank-position {
        font-size: 3rem;
        font-weight: 900;
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
    }

    .rank-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: 4px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .stat-item {
        text-align: center;
        padding: 12px;
        background: rgba(220, 38, 38, 0.05);
        border-radius: 8px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #dc2626;
        line-height: 1;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: 4px;
    }

    .progress-section {
        margin-top: 16px;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 0.875rem;
        color: #374151;
    }

    .progress-percentage {
        font-weight: 600;
        color: #dc2626;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .matching-grid.three-column,
        .matching-grid.two-column {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .connector-icon {
            transform: rotate(90deg);
        }

        .timer-container {
            margin-bottom: 15px;
        }

        .timer-display {
            font-size: 1.25rem;
        }

        .matching-column {
            min-height: 200px;
            padding: 16px;
        }

        .drop-zone-slot {
            min-height: 44px;
            padding: 10px;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .rank-position {
            font-size: 2.5rem;
        }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse-animation {
        animation: pulse 0.3s ease-in-out;
    }

    /* –£—Ç–∏–ª–∏—Ç—ã */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-4 { margin-top: 1rem; }
    .flex { display: flex; }
    .justify-between { justify-content: space-between; }
    .items-center { align-items: center; }
    .gap-4 { gap: 1rem; }
    .hidden { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="container ">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥ -->
    <div class="mb-6">
        <a href="{{ url_for('view_olympiad', olympiad_id=olympiad.id) }}" class="text-blue-600 hover:text-blue-800">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ª–∏–º–ø–∏–∞–¥–µ
        </a>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–ª–∏–º–ø–∏–∞–¥—ã -->
    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ olympiad.title }}</h1>
        <h2 class="text-lg text-gray-700 mb-4">–ë–ª–æ–∫: {{ block.title }}</h2>

        {% if block.description %}
            <p class="text-gray-600 mb-4">{{ block.description }}</p>
        {% endif %}

        <!-- –¢–∞–π–º–µ—Ä—ã -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="timer-container">
                <div class="timer-label">–í—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞</div>
                <div id="elapsed-timer" class="timer-display">00:00:00</div>
            </div>
            <div class="timer-container">
                <div class="timer-label">–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è</div>
                <div id="remaining-timer" class="timer-display">00:00:00</div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->


    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->


    <!-- –í–æ–ø—Ä–æ—Å—ã -->
    <div class="space-y-6">
        {% for question in questions %}
            <div id="question-{{ question.id }}"
                 class="question-card {% if question.id in user_answers %}answered{% endif %}"
                 data-question-id="{{ question.id }}"
                 data-question-type="{{ question.question_type }}">

                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-start">
                        <div class="bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 mt-1">
                            {{ loop.index }}
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ question.text }}</h3>
                    </div>
                    <div id="answer-status-{{ question.id }}" class="{% if question.id not in user_answers %}hidden{% endif %} text-green-600 bg-green-100 px-3 py-1 rounded text-sm">
                        ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
                <form id="question-form-{{ question.id }}">
                    {% if question.question_type == 'test' %}
                        <div class="space-y-3">
                            {% if question.options_list %}
                                {% set isMultiple = question.correct_answers_list|length > 1 %}
                                {% for option in question.options_list %}
                                    <label class="answer-option">
                                        <input type="{% if isMultiple %}checkbox{% else %}radio{% endif %}"
                                               name="question-{{ question.id }}"
                                               value="{{ option }}"
                                               class="answer-input"
                                               {% if question.id in user_answers and option in user_answers[question.id] %}checked{% endif %}>
                                        <span>{{ option }}</span>
                                    </label>
                                {% endfor %}
                            {% else %}
                                <div class="info-block error">
                                    –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
                                </div>
                            {% endif %}
                        </div>
                    {% elif question.question_type == 'matching' %}
                        <div class="matching-container" id="matching-container-{{ question.id }}">
                            {% if question.matches_data or question.matches_list %}
                                <!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è JavaScript -->
                                {% if question.matches_data %}
                                    <input type="hidden" id="matching-data-{{ question.id }}" value="{{ question.matches_data|tojson }}">
                                {% else %}
                                    <input type="hidden" id="matching-data-{{ question.id }}" value="{{ question.matches_list|tojson }}">
                                {% endif %}

                                <div class="info-block info mb-4">
                                    <span id="instruction-text-{{ question.id }}">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π...</span>
                                    <br><small style="margin-top: 8px; display: block;">
                                        üí° <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥—Ä—É–≥–æ–π —ç–ª–µ–º–µ–Ω—Ç
                                    </small>
                                </div>

                                <div class="matching-grid" id="matching-grid-{{ question.id }}">
                                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                                    <div class="matching-column left">
                                        <h4>–≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</h4>
                                        <div id="left-items-{{ question.id }}"></div>
                                    </div>

                                    <!-- –ü–µ—Ä–≤—ã–π —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å -->
                                    <div class="matching-connector">
                                        <svg class="connector-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </div>

                                    <!-- –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ (—É—Å–ª–æ–≤–Ω–∞—è) -->
                                    <div class="matching-column middle" id="middle-column-{{ question.id }}" style="display: none;">
                                        <h4>–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã</h4>
                                        <div id="middle-items-{{ question.id }}"></div>
                                    </div>

                                    <!-- –í—Ç–æ—Ä–æ–π —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å (—É—Å–ª–æ–≤–Ω—ã–π) -->
                                    <div class="matching-connector" id="second-connector-{{ question.id }}" style="display: none;">
                                        <svg class="connector-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </div>

                                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                                    <div class="matching-column right">
                                        <h4>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤</h4>
                                        <div id="right-items-{{ question.id }}"></div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="info-block error">
                                    –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ -->
                    <div class="mt-6 flex justify-between items-center">
                        <button type="button"
                                class="btn {% if question.id in user_answers %}btn-success{% else %}btn-primary{% endif %} answer-button"
                                data-question-id="{{ question.id }}">
                            {% if question.id in user_answers %}
                                ‚úì –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                            {% else %}
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
                            {% endif %}
                        </button>
                        <div class="text-sm text-gray-600">
                            –ë–∞–ª–ª—ã: <strong>{{ "%.1f"|format(question.points) }}</strong>
                        </div>
                    </div>
                </form>
            </div>
        {% endfor %}
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="bg-white border border-gray-200 rounded-lg p-6 mt-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º</h3>
                <p class="text-gray-600">
                    –û—Ç–≤–µ—á–µ–Ω–æ: <span id="answers-count" class="font-bold text-red-600">{{ user_answers|length }}</span> –∏–∑ <span class="font-bold">{{ questions|length }}</span>
                </p>
                <p class="text-sm text-gray-500 mt-1">
                    –ú–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤ –∑–∞ –±–ª–æ–∫: <strong>{{ "%.1f"|format(block.max_points) }}</strong>
                </p>
            </div>
            <div class="flex gap-4">
                <button onclick="showEarlyFinishModal()" class="btn btn-warning">
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ
                </button>
                <button id="submit-block-button"
                        class="btn btn-primary"
                        {% if user_answers|length < questions|length %}disabled{% endif %}>
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å –±–ª–æ–∫
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
<div id="early-finish-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–î–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ</h3>
            <button onclick="closeEarlyFinishModal()" class="modal-close">&times;</button>
        </div>
        <div class="text-center">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h4 class="text-lg font-semibold mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É –¥–æ—Å—Ä–æ—á–Ω–æ?</h4>
            <div class="info-block warning text-left mb-6">
                <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong>
                <ul class="mt-2 space-y-1">
                    <li>‚Ä¢ –í—ã –Ω–µ –ø–æ–ª—É—á–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±–æ–Ω—É—Å</li>
                    <li>‚Ä¢ –ë—É–¥—É—Ç –∑–∞—Å—á–∏—Ç–∞–Ω—ã —Ç–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</li>
                    <li>‚Ä¢ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ</li>
                </ul>
            </div>
            <div class="flex gap-4">
                <button onclick="closeEarlyFinishModal()" class="btn btn-secondary">
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—É
                </button>
                <button onclick="finishEarly()" class="btn btn-warning">
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–ª–æ–∫–∞ -->
<div id="block-result-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç –±–ª–æ–∫–∞</h3>
            <button onclick="closeBlockResultModal()" class="modal-close">&times;</button>
        </div>
        <div id="block-result-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let startTime = new Date('{{ participation.start_time.isoformat() }}');
    let endTime = new Date('{{ olympiad.end_time.isoformat() }}');
    let draggedElement = null;
    const olympiadId = {{ olympiad.id }};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        updateTimers();
        setInterval(updateTimers, 1000);

        initMatchingQuestions();
        updateRanking(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
        setInterval(updateRanking, 30000);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.querySelectorAll('.answer-input').forEach(input => {
            input.addEventListener('change', function() {
                const questionId = this.name.split('-')[1];
                highlightAnswerButton(questionId);
            });
        });

        document.querySelectorAll('.answer-button').forEach(button => {
            button.addEventListener('click', function() {
                const questionId = this.dataset.questionId;
                submitAnswer(questionId);
            });
        });

        document.getElementById('submit-block-button').addEventListener('click', submitBlock);
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
    function updateRanking() {
        fetch(`/olympiad/${olympiadId}/ranking`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–∞
                    const rankElement = document.getElementById('rank-position-display');
                    if (data.in_progress) {
                        rankElement.textContent = '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                        rankElement.style.fontSize = '1.5rem';
                    } else if (data.rank_position > 0) {
                        rankElement.textContent = data.rank_position;
                        rankElement.style.fontSize = '3rem';
                    } else {
                        rankElement.textContent = '‚Äî';
                        rankElement.style.fontSize = '3rem';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª—ã
                    document.getElementById('block-points-display').textContent =
                        parseFloat(data.block_points || 0).toFixed(1);
                    document.getElementById('total-points-display').textContent =
                        parseFloat(data.total_points || 0).toFixed(1);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–ª–æ–∫–∞
                    const blockProgress = data.block_max_points > 0
                        ? Math.round((data.block_points / data.block_max_points) * 100)
                        : 0;

                    document.getElementById('block-percentage-display').textContent = blockProgress + '%';
                    document.getElementById('block-progress-fill').style.width = blockProgress + '%';

                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞
                    if (data.block_name) {
                        document.getElementById('block-name-display').textContent = data.block_name;
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞:', data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
            });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤
    function updateTimers() {
        const now = new Date();

        // –í—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞
        const elapsed = now - startTime;
        const elapsedHours = Math.floor(elapsed / (1000 * 60 * 60));
        const elapsedMins = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
        const elapsedSecs = Math.floor((elapsed % (1000 * 60)) / 1000);

        document.getElementById('elapsed-timer').textContent =
            `${elapsedHours.toString().padStart(2, '0')}:${elapsedMins.toString().padStart(2, '0')}:${elapsedSecs.toString().padStart(2, '0')}`;

        // –í—Ä–µ–º—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        const remaining = endTime - now;

        if (remaining > 0) {
            const remainingHours = Math.floor(remaining / (1000 * 60 * 60));
            const remainingMins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const remainingSecs = Math.floor((remaining % (1000 * 60)) / 1000);

            document.getElementById('remaining-timer').textContent =
                `${remainingHours.toString().padStart(2, '0')}:${remainingMins.toString().padStart(2, '0')}:${remainingSecs.toString().padStart(2, '0')}`;
        } else {
            document.getElementById('remaining-timer').textContent = '00:00:00';
            showMessage('–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ! –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞...', 'warning');
            setTimeout(submitBlock, 2000);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
    function initMatchingQuestions() {
        document.querySelectorAll('.matching-container').forEach(container => {
            const questionId = container.closest('[data-question-id]').dataset.questionId;
            const dataElement = document.getElementById(`matching-data-${questionId}`);

            if (!dataElement) return;

            try {
                let data = JSON.parse(dataElement.value);
                let leftItems, middleItems = [], rightItems, correctMatches, isThreeColumn = false;

                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
                if (data && data.columns) {
                    leftItems = data.left_items || [];
                    middleItems = data.middle_items || [];
                    rightItems = data.right_items || [];
                    correctMatches = data.correct_matches || {};
                    isThreeColumn = data.columns === 3;
                } else if (data && data.left_items) {
                    leftItems = data.left_items || [];
                    middleItems = data.middle_items || [];
                    rightItems = data.right_items || [];
                    correctMatches = data.correct_matches || {};
                    isThreeColumn = middleItems.length > 0;
                } else if (Array.isArray(data)) {
                    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
                    leftItems = data.map(m => m.left);
                    rightItems = data.map(m => m.right);
                    correctMatches = {};
                    data.forEach(m => {
                        correctMatches[m.left] = { right: m.right };
                    });
                    isThreeColumn = false;
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏
                const grid = document.getElementById(`matching-grid-${questionId}`);
                if (isThreeColumn) {
                    grid.classList.add('three-column');
                    document.getElementById(`middle-column-${questionId}`).style.display = 'block';
                    document.getElementById(`second-connector-${questionId}`).style.display = 'flex';
                } else {
                    grid.classList.add('two-column');
                }

                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                const instruction = document.getElementById(`instruction-text-${questionId}`);
                instruction.textContent = isThreeColumn ?
                    '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ —Å—Ä–µ–¥–Ω–µ–π –∏ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–æ–∫ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏' :
                    '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏';

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
                const leftContainer = document.getElementById(`left-items-${questionId}`);
                leftContainer.innerHTML = '';

                leftItems.forEach((item, index) => {
                    const element = document.createElement('div');
                    element.className = 'matching-item left-item';
                    element.dataset.leftItem = item;
                    element.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 10px;">${item}</div>
                        <div class="drop-zone-container">
                            ${isThreeColumn ? `<div class="drop-zone-slot middle-slot" data-slot-type="middle" data-left-item="${item}" data-question-id="${questionId}">–°—Ä–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç<button class="remove-button" onclick="removeFromSlot(this)">√ó</button></div>` : ''}
                            <div class="drop-zone-slot right-slot" data-slot-type="right" data-left-item="${item}" data-question-id="${questionId}">–ü—Ä–∞–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç<button class="remove-button" onclick="removeFromSlot(this)">√ó</button></div>
                        </div>
                    `;

                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    element.querySelectorAll('.drop-zone-slot').forEach(slot => {
                        slot.addEventListener('dragover', handleDragOver);
                        slot.addEventListener('dragleave', handleDragLeave);
                        slot.addEventListener('drop', handleDrop);
                    });

                    leftContainer.appendChild(element);
                });

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π –∫–æ–ª–æ–Ω–∫–∏
                if (isThreeColumn && middleItems.length > 0) {
                    const middleContainer = document.getElementById(`middle-items-${questionId}`);
                    middleContainer.innerHTML = '';

                    shuffleArray(middleItems).forEach(item => {
                        const element = document.createElement('div');
                        element.className = 'matching-item middle-item';
                        element.textContent = item;
                        element.dataset.middleItem = item;
                        element.dataset.questionId = questionId;
                        element.draggable = true;

                        element.addEventListener('dragstart', handleDragStart);
                        element.addEventListener('dragend', handleDragEnd);

                        middleContainer.appendChild(element);
                    });
                }

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
                const rightContainer = document.getElementById(`right-items-${questionId}`);
                rightContainer.innerHTML = '';

                shuffleArray(rightItems).forEach(item => {
                    const element = document.createElement('div');
                    element.className = 'matching-item right-item';
                    element.textContent = item;
                    element.dataset.rightItem = item;
                    element.dataset.questionId = questionId;
                    element.draggable = true;

                    element.addEventListener('dragstart', handleDragStart);
                    element.addEventListener('dragend', handleDragEnd);

                    rightContainer.appendChild(element);
                });

                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                restoreSavedAnswers(questionId);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–∞:', error);
            }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        const itemType = this.classList.contains('middle-item') ? 'middle' : 'right';
        const itemValue = this.dataset[itemType + 'Item'];

        e.dataTransfer.setData('text/plain', itemValue);
        e.dataTransfer.setData('application/x-item-type', itemType);
        e.dataTransfer.setData('application/x-question-id', this.dataset.questionId);
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        const questionId = this.dataset.questionId;
        updateUsedItemsVisual(questionId);
        highlightAnswerButton(questionId);
        draggedElement = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');

        const itemValue = e.dataTransfer.getData('text/plain');
        const itemType = e.dataTransfer.getData('application/x-item-type');
        const questionId = e.dataTransfer.getData('application/x-question-id');
        const slotType = this.dataset.slotType;

        if (!itemValue || itemType !== slotType) return;

        const draggedElement = document.querySelector(`.${itemType}-item[data-${itemType}-item="${itemValue}"][data-question-id="${questionId}"]`);
        if (!draggedElement) return;

        // –ï—Å–ª–∏ –≤ —Å–ª–æ—Ç–µ —É–∂–µ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ
        const existingItem = this.querySelector(`.${itemType}-item`);
        if (existingItem) {
            returnItemToColumn(existingItem, questionId);
        }

        // –†–∞–∑–º–µ—â–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ª–æ—Ç–µ
        placeItemInSlot(this, draggedElement, questionId);
    }

    // –†–∞–∑–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Å–ª–æ—Ç–µ
    function placeItemInSlot(slot, element, questionId) {
        // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ª–æ—Ç–∞, –∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        const removeButton = slot.querySelector('.remove-button');
        slot.innerHTML = '';
        slot.appendChild(element);
        slot.appendChild(removeButton);
        slot.classList.add('filled');

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        slot.classList.add('pulse-animation');
        setTimeout(() => slot.classList.remove('pulse-animation'), 300);

        updateUsedItemsVisual(questionId);
        highlightAnswerButton(questionId);
    }

    // –í–æ–∑–≤—Ä–∞—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–ª–æ–Ω–∫—É
    function returnItemToColumn(element, questionId) {
        const itemType = element.classList.contains('middle-item') ? 'middle' : 'right';
        const columnContainer = document.getElementById(`${itemType}-items-${questionId}`);

        if (columnContainer) {
            columnContainer.appendChild(element);
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Å–ª–æ—Ç–∞
    function removeFromSlot(button) {
        const slot = button.parentElement;
        const element = slot.querySelector('.matching-item:not(.left-item)');
        const questionId = slot.dataset.questionId;

        if (element) {
            returnItemToColumn(element, questionId);
            slot.classList.remove('filled');
            slot.innerHTML = slot.classList.contains('middle-slot') ?
                '–°—Ä–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç<button class="remove-button" onclick="removeFromSlot(this)">√ó</button>' :
                '–ü—Ä–∞–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç<button class="remove-button" onclick="removeFromSlot(this)">√ó</button>';

            updateUsedItemsVisual(questionId);
            highlightAnswerButton(questionId);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function updateUsedItemsVisual(questionId) {
        const container = document.getElementById(`matching-container-${questionId}`);
        if (!container) return;

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        container.querySelectorAll('.matching-item:not(.left-item)').forEach(item => {
            item.classList.remove('used');
        });

        // –ü–æ–º–µ—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        container.querySelectorAll('.drop-zone-slot.filled .matching-item').forEach(item => {
            const originalItem = container.querySelector(
                `.matching-item[data-${item.classList.contains('middle-item') ? 'middle' : 'right'}-item="${item.dataset.middleItem || item.dataset.rightItem}"]`
            );
            if (originalItem && originalItem.parentElement.id.includes('-items-')) {
                originalItem.classList.add('used');
            }
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
    function submitAnswer(questionId) {
        const questionContainer = document.getElementById(`question-${questionId}`);
        const questionType = questionContainer.dataset.questionType;
        let answerData;

        if (questionType === 'matching') {
            answerData = [];
            const leftItems = questionContainer.querySelectorAll('.left-item');

            leftItems.forEach(leftItem => {
                const leftValue = leftItem.dataset.leftItem;
                const answerPair = { left: leftValue };

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                const middleSlot = leftItem.querySelector('.drop-zone-slot.middle-slot');
                if (middleSlot) {
                    const middleElement = middleSlot.querySelector('.middle-item');
                    if (middleElement) {
                        answerPair.middle = middleElement.dataset.middleItem;
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                const rightSlot = leftItem.querySelector('.drop-zone-slot.right-slot');
                if (rightSlot) {
                    const rightElement = rightSlot.querySelector('.right-item');
                    if (rightElement) {
                        answerPair.right = rightElement.dataset.rightItem;
                    }
                }

                if (answerPair.middle || answerPair.right) {
                    answerData.push(answerPair);
                }
            });

            if (answerData.length === 0) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è', 'error');
                return;
            }
        } else {
            const inputs = questionContainer.querySelectorAll('input:checked');
            if (inputs.length === 0) {
                showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç', 'error');
                return;
            }
            answerData = Array.from(inputs).map(input => input.value);
        }

        const button = questionContainer.querySelector('.answer-button');
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        button.disabled = true;

        fetch(`{{ url_for("submit_answer", olympiad_id=olympiad.id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: questionId,
                answer_data: answerData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                markQuestionAnswered(questionId);
                showMessage(`–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`, 'success');
                updateProgress();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                setTimeout(updateRanking, 1000);
            } else {
                showMessage(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error');
            }
        })
        .catch(error => {
            showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            console.error('–û—à–∏–±–∫–∞:', error);
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–ª–æ–∫–∞
    function submitBlock() {
        const totalQuestions = {{ questions|length }};
        const answeredQuestions = document.querySelectorAll('.question-card.answered').length;

        if (answeredQuestions < totalQuestions) {
            showMessage(`–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã (${answeredQuestions}/${totalQuestions})`, 'error');
            return;
        }

        const button = document.getElementById('submit-block-button');
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–ª–æ–∫–∞...';
        button.disabled = true;

        fetch(`{{ url_for("submit_block", olympiad_id=olympiad.id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–ª–æ–∫–∞
                if (data.block_data) {
                    showBlockResult(data);
                }

                // –ï—Å–ª–∏ –æ–ª–∏–º–ø–∏–∞–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (data.completed) {
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 3000);
                } else {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 3000);
                }
            } else {
                showMessage(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±–ª–æ–∫–∞', 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            console.error('–û—à–∏–±–∫–∞:', error);
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–ª–æ–∫–∞
    function showBlockResult(data) {
        const content = `
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">${data.completed ? 'üéâ' : '‚úÖ'}</div>
                <h4 class="text-xl font-bold mb-2">${data.completed ? '–û–ª–∏–º–ø–∏–∞–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!' : '–ë–ª–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!'}</h4>
                <p class="text-gray-600 mb-4">${data.message}</p>
            </div>

            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h5 class="font-semibold mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–ª–æ–∫–∞ "${data.block_data.block_name}":</h5>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-primary">${data.block_data.points_earned}</div>
                        <div class="text-sm text-gray-600">–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-700">${data.block_data.total_points_possible}</div>
                        <div class="text-sm text-gray-600">–ú–∞–∫—Å–∏–º—É–º</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold ${data.block_data.percentage >= 70 ? 'text-green-600' : 'text-orange-600'}">${data.block_data.percentage}%</div>
                        <div class="text-sm text-gray-600">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <div class="text-sm text-gray-500 mb-4">
                    ${data.completed ? '–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º...' : '–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É...'}
                </div>
                <div class="bg-gray-200 rounded-full h-2">
                    <div class="bg-primary h-2 rounded-full animate-pulse" style="width: 0%; animation: loading 3s ease-in-out forwards;"></div>
                </div>
            </div>

            <style>
                @keyframes loading {
                    from { width: 0%; }
                    to { width: 100%; }
                }
            </style>
        `;

        document.getElementById('block-result-content').innerHTML = content;
        document.getElementById('block-result-modal').style.display = 'flex';
    }

    function closeBlockResultModal() {
        document.getElementById('block-result-modal').style.display = 'none';
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function highlightAnswerButton(questionId) {
        const button = document.querySelector(`.answer-button[data-question-id="${questionId}"]`);
        if (button && !button.classList.contains('btn-success')) {
            button.style.backgroundColor = '#f59e0b';
            setTimeout(() => {
                button.style.backgroundColor = '';
            }, 2000);
        }
    }

    function markQuestionAnswered(questionId) {
        const card = document.getElementById(`question-${questionId}`);
        const status = document.getElementById(`answer-status-${questionId}`);
        const button = card.querySelector('.answer-button');

        card.classList.add('answered');
        status.classList.remove('hidden');
        button.innerHTML = '‚úì –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω';
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
    }

    function updateProgress() {
        const answered = document.querySelectorAll('.question-card.answered').length;
        const total = {{ questions|length }};

        document.getElementById('answer-count').textContent = answered;
        document.getElementById('answers-count').textContent = answered;
        document.getElementById('progress-fill').style.width = `${(answered / total) * 100}%`;

        const submitButton = document.getElementById('submit-block-button');
        if (answered >= total) {
            submitButton.disabled = false;
        }
    }

    function restoreSavedAnswers(questionId) {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ user_answers
        {% for q_id, answers in user_answers.items() %}
            if ('{{ q_id }}' === questionId) {
                const card = document.getElementById(`question-${questionId}`);
                if (card) {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π
                    markQuestionAnswered(questionId);
                }
            }
        {% endfor %}
    }

    function showMessage(message, type = 'info') {
        const colors = {
            success: 'bg-green-100 border-green-500 text-green-700',
            error: 'bg-red-100 border-red-500 text-red-700',
            warning: 'bg-yellow-100 border-yellow-500 text-yellow-700',
            info: 'bg-blue-100 border-blue-500 text-blue-700'
        };

        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 border-l-4 rounded ${colors[type]} max-w-sm shadow-lg`;
        notification.innerHTML = `
            <div class="flex justify-between items-start">
                <span class="pr-2">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 font-bold text-lg leading-none">&times;</button>
            </div>
        `;

        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    function showEarlyFinishModal() {
        document.getElementById('early-finish-modal').style.display = 'flex';
    }

    function closeEarlyFinishModal() {
        document.getElementById('early-finish-modal').style.display = 'none';
    }

    function finishEarly() {
        fetch(`{{ url_for("finish_olympiad_early", olympiad_id=olympiad.id) }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                showMessage(data.message, 'error');
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –Ω–∏—Ö
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
</script>
{% endblock %}