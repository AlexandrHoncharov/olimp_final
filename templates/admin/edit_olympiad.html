{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ª–∏–º–ø–∏–∞–¥—ã - {{ olympiad.title }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('admin_olympiads') }}" class="text-primary hover:underline">&larr; –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –æ–ª–∏–º–ø–∏–∞–¥</a>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex justify-between items-start mb-6">
            <h1 class="text-2xl font-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ª–∏–º–ø–∏–∞–¥—ã: {{ olympiad.title }}</h1>

            <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
            <div class="flex gap-2">
                <button onclick="diagnoseOlympiad({{ olympiad.id }})"
                        class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                    üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                </button>
                <button onclick="fixOlympiadPoints({{ olympiad.id }})"
                        class="px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm">
                    üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–ª–ª—ã
                </button>
                {% if olympiad.participations|selectattr('status', 'equalto', 'completed')|list|length > 0 %}
                    <a href="{{ url_for('admin_rankings', olympiad_id=olympiad.id) }}"
                       class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                        üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </a>
                {% endif %}
            </div>
        </div>

        <form id="edit-olympiad-form" enctype="multipart/form-data">
            <div class="space-y-4">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ª–∏–º–ø–∏–∞–¥—ã</label>
                    <input type="text" id="title" name="title" value="{{ olympiad.title }}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="description" name="description" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">{{ olympiad.description }}</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start_time" class="block text-sm font-medium text-gray-700 mb-1">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
                        <input type="datetime-local" id="start_time" name="start_time" value="{{ olympiad.start_time.strftime('%Y-%m-%dT%H:%M') }}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div>
                        <label for="end_time" class="block text-sm font-medium text-gray-700 mb-1">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="datetime-local" id="end_time" name="end_time" value="{{ olympiad.end_time.strftime('%Y-%m-%dT%H:%M') }}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
                <div>
                    <label for="welcome_pdf" class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π PDF</label>
                    {% if olympiad.welcome_pdf %}
                        <div class="mb-2 flex items-center">
                            <span class="text-sm text-gray-600 mr-2">–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: {{ olympiad.welcome_pdf }}</span>
                            <a href="{{ url_for('static', filename='pdf_files/' + olympiad.welcome_pdf) }}" target="_blank" class="text-primary hover:underline text-sm">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                        </div>
                    {% endif %}
                    <input type="file" id="welcome_pdf" name="welcome_pdf" accept=".pdf" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    <p class="text-sm text-gray-500 mt-1">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª</p>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="updateOlympiad()" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
        </form>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">–ë–ª–æ–∫–∏ –æ–ª–∏–º–ø–∏–∞–¥—ã</h2>
            <button
                onclick="showAddBlockModal()"
                class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
            >
                –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
            </button>
        </div>

        {% if blocks %}
            <div class="space-y-4">
                {% for block in blocks %}
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 p-4 flex justify-between items-center">
                            <div class="flex-1">
                                <h3 class="font-medium">{{ block.title }}</h3>
                                <div class="text-sm text-gray-600 mt-1">
                                    –ú–∞–∫—Å–∏–º—É–º –±–∞–ª–ª–æ–≤: <span class="font-semibold">{{ block.max_points }}</span>,
                                    –ü–æ—Ä–æ–≥: <span class="font-semibold">{{ block.threshold_percentage }}%</span>
                                </div>

                                <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–µ -->
                                {% set questions = block.questions %}
                                {% if questions %}
                                    {% set total_question_points = questions|sum(attribute='points') %}
                                    <div class="text-xs mt-2 p-2 rounded {% if (total_question_points - block.max_points)|abs < 0.01 %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                                        –°—É–º–º–∞ –±–∞–ª–ª–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤: <strong>{{ "%.1f"|format(total_question_points) }}</strong>
                                        {% if (total_question_points - block.max_points)|abs >= 0.01 %}
                                            ‚ö†Ô∏è –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∞–∫—Å–∏–º—É–º—É –±–ª–æ–∫–∞!
                                        {% else %}
                                            ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="diagnoseBlock({{ block.id }})"
                                        class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                    üîç
                                </button>
                                <button onclick="fixBlockPoints({{ block.id }})"
                                        class="px-2 py-1 bg-orange-500 text-white rounded text-xs hover:bg-orange-600">
                                    üîß
                                </button>
                                <a href="{{ url_for('edit_block', block_id=block.id) }}"
                                   class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition text-sm">
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </a>
                            </div>
                        </div>

                        {% if questions %}
                            <div class="p-4">
                                <div class="text-sm font-medium mb-2 flex justify-between items-center">
                                    <span>–í–æ–ø—Ä–æ—Å—ã ({{ questions|length }})</span>
                                    <span class="text-xs text-gray-500">
                                        –ü–æ {{ "%.1f"|format(block.max_points / questions|length if questions|length > 0 else 0) }} –±–∞–ª–ª–æ–≤ –∑–∞ –≤–æ–ø—Ä–æ—Å
                                    </span>
                                </div>

                                <ul class="space-y-2">
                                    {% for question in questions %}
                                        <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                            <div class="flex-1">
                                                <span class="font-medium">{{ loop.index }}. {{ question.text[:50] }}{% if question.text|length > 50 %}...{% endif %}</span>
                                                <span class="text-sm text-gray-600 ml-2">({{ question.question_type }})</span>
                                            </div>
                                            <div class="text-sm font-semibold {% if question.points != (block.max_points / questions|length) %}text-red-600{% else %}text-green-600{% endif %}">
                                                {{ "%.1f"|format(question.points) }} –±.
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <div class="p-4 text-center text-gray-500 italic">
                                –í —ç—Ç–æ–º –±–ª–æ–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center p-8 text-gray-500">
                <p>–£ —ç—Ç–æ–π –æ–ª–∏–º–ø–∏–∞–¥—ã –ø–æ–∫–∞ –Ω–µ—Ç –±–ª–æ–∫–æ–≤</p>
                <button
                    onclick="showAddBlockModal()"
                    class="mt-3 px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
                >
                    –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                </button>
            </div>
        {% endif %}
    </div>

    {% if olympiad.participations %}
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ olympiad.participations|length }})</h2>

            <div class="overflow-x-auto">
                <table class="w-full min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-2 text-left">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                            <th class="px-4 py-2 text-left">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-4 py-2 text-left">–ù–∞—á–∞–ª–æ</th>
                            <th class="px-4 py-2 text-left">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</th>
                            <th class="px-4 py-2 text-left">–ë–∞–ª–ª—ã –∑–∞ –∑–∞–¥–∞–Ω–∏—è</th>
                            <th class="px-4 py-2 text-left">–í—Ä–µ–º–µ–Ω–Ω–æ–π –±–æ–Ω—É—Å</th>
                            <th class="px-4 py-2 text-left">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</th>
                            <th class="px-4 py-2 text-left">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in olympiad.participations %}
                            {% set user = p.user %}
                            <tr class="{% if loop.index % 2 == 0 %}bg-gray-50{% endif %}">
                                <td class="px-4 py-3 border-b">{{ user.full_name }}</td>
                                <td class="px-4 py-3 border-b">
                                    {% if p.status == 'completed' %}
                                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                    {% elif p.status == 'in_progress' %}
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                                    {% else %}
                                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 border-b text-sm">
                                    {% if p.start_time %}
                                        {{ p.start_time.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 border-b text-sm">
                                    {% if p.finish_time %}
                                        {{ p.finish_time.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 border-b font-semibold">{{ "%.1f"|format(p.total_points) }}</td>
                                <td class="px-4 py-3 border-b {% if p.time_bonus and p.time_bonus > 0 %}text-green-600 font-semibold{% else %}text-gray-500{% endif %}">
                                    {% if p.time_bonus and p.time_bonus > 0 %}
                                        +{{ "%.1f"|format(p.time_bonus) }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 border-b font-bold text-primary">{{ "%.1f"|format(p.final_score) }}</td>
                                <td class="px-4 py-3 border-b">
                                    <button onclick="showParticipationDetails({{ p.id }})"
                                            class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                        –î–µ—Ç–∞–ª–∏
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if olympiad.participations|selectattr('status', 'equalto', 'completed')|list|length > 0 %}
                <div class="mt-4 flex justify-end">
                    <a
                        href="{{ url_for('admin_rankings', olympiad_id=olympiad.id) }}"
                        class="inline-block px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
                    >
                        –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </a>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ -->
    <div id="add-block-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞</h3>
                <button onclick="closeAddBlockModal()" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <form id="add-block-form">
                    <div class="space-y-4">
                        <div>
                            <label for="block_title" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞</label>
                            <input type="text" id="block_title" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label for="block_description" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <textarea id="block_description" name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                        </div>
                        <div>
                            <label for="max_points" class="block text-sm font-medium text-gray-700 mb-1">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –∑–∞ –±–ª–æ–∫</label>
                            <input type="number" id="max_points" name="max_points" min="1" step="0.1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                        </div>
                        <div>
                            <label for="threshold_percentage" class="block text-sm font-medium text-gray-700 mb-1">–ü–æ—Ä–æ–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)</label>
                            <input type="number" id="threshold_percentage" name="threshold_percentage" min="1" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                            <p class="text-sm text-gray-500 mt-1">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                <button onclick="closeAddBlockModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="submitAddBlockForm()" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
    <div id="diagnostic-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <button onclick="closeDiagnosticModal()" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <div id="diagnostic-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateOlympiad() {
        const form = document.getElementById('edit-olympiad-form');
        const formData = new FormData(form);

        axios.post('{{ url_for("update_olympiad", olympiad_id=olympiad.id) }}', formData)
            .then(function(response) {
                if (response.data.success) {
                    showMessage('–û–ª–∏–º–ø–∏–∞–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage(response.data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–ª–∏–º–ø–∏–∞–¥—ã', 'error');
                }
            })
            .catch(function(error) {
                showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (error.response?.data?.message || error.message), 'error');
            });
    }

    function showAddBlockModal() {
        const modal = document.getElementById('add-block-modal');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeAddBlockModal() {
        const modal = document.getElementById('add-block-modal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function closeDiagnosticModal() {
        const modal = document.getElementById('diagnostic-modal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function submitAddBlockForm() {
        const form = document.getElementById('add-block-form');
        const formData = new FormData(form);

        const submitBtn = event.target;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
        submitBtn.disabled = true;

        axios.post('{{ url_for("add_block", olympiad_id=olympiad.id) }}', formData)
            .then(function(response) {
                if (response.data.success) {
                    showMessage('–ë–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    setTimeout(() => {
                        window.location.href = '/admin/block/' + response.data.block_id + '/edit';
                    }, 1000);
                } else {
                    showMessage(response.data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–ª–æ–∫–∞', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(function(error) {
                showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (error.response?.data?.message || error.message), 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function fixOlympiadPoints(olympiadId) {
        if (!confirm('–ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–ª–ª—ã –¥–ª—è –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —ç—Ç–æ–π –æ–ª–∏–º–ø–∏–∞–¥—ã?')) {
            return;
        }

        const button = event.target;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '‚è≥ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';

        fetch(`/admin/fix_points/${olympiadId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('‚úÖ ' + data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showMessage('‚ùå –û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤', 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }

    function diagnoseBlock(blockId) {
        fetch(`/admin/block/${blockId}/diagnose`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const content = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${data.block_name}</div>
                                <div><strong>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã –±–ª–æ–∫–∞:</strong> ${data.max_points}</div>
                                <div><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤:</strong> ${data.questions_count}</div>
                                <div><strong>–ë–∞–ª–ª–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å:</strong> ${data.points_per_question}</div>
                                <div><strong>–°—É–º–º–∞ –±–∞–ª–ª–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤:</strong> ${data.total_question_points}</div>
                                <div><strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –æ—Ç–≤–µ—Ç–∞–º–∏:</strong> ${data.participants_count}</div>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg ${Math.abs(data.total_question_points - data.max_points) < 0.01 ? 'bg-green-50' : 'bg-red-50'}">
                            <h4 class="font-semibold mb-2 ${Math.abs(data.total_question_points - data.max_points) < 0.01 ? 'text-green-800' : 'text-red-800'}">
                                –°—Ç–∞—Ç—É—Å: ${Math.abs(data.total_question_points - data.max_points) < 0.01 ? '‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ' : '‚ùå –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è'}
                            </h4>
                            ${Math.abs(data.total_question_points - data.max_points) >= 0.01 ? '<p class="text-sm text-red-700">–°—É–º–º–∞ –±–∞–ª–ª–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –±–∞–ª–ª–∞–º –±–ª–æ–∫–∞.</p>' : '<p class="text-sm text-green-700">–í—Å–µ –±–∞–ª–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.</p>'}
                        </div>

                        ${data.questions_details && data.questions_details.length > 0 ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">–ü–µ—Ä–≤—ã–µ 5 –≤–æ–ø—Ä–æ—Å–æ–≤</h4>
                            <div class="space-y-2">
                                ${data.questions_details.map((q, i) => `
                                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                                        <span class="text-sm">${i + 1}. ${q.text} (${q.type})</span>
                                        <span class="font-semibold">${q.points} –±.</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="flex justify-end">
                            <button onclick="fixBlockPoints(${blockId})" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                                üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–ª–ª—ã –±–ª–æ–∫–∞
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('diagnostic-content').innerHTML = content;
                document.getElementById('diagnostic-modal').classList.remove('hidden');
            } else {
                showMessage('–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –±–ª–æ–∫–∞', 'error');
        });
    }

    function diagnoseOlympiad(olympiadId) {
        fetch(`/admin/olympiad/${olympiadId}/diagnose`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const content = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>–û–ª–∏–º–ø–∏–∞–¥–∞:</strong> ${data.olympiad_title}</div>
                                <div><strong>–û–±—â–∏–µ –±–∞–ª–ª—ã:</strong> ${data.total_olympiad_points}</div>
                                <div><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤:</strong> ${data.blocks_count}</div>
                                <div><strong>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> ${data.total_participants}</div>
                                <div><strong>–ó–∞–≤–µ—Ä—à–∏–ª–∏:</strong> ${data.completed_participants}</div>
                                <div><strong>–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:</strong> ${data.has_issues ? '‚ùå –î–∞' : '‚úÖ –ù–µ—Ç'}</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">–ë–ª–æ–∫–∏ –æ–ª–∏–º–ø–∏–∞–¥—ã</h4>
                            <div class="space-y-2">
                                ${data.blocks.map(block => `
                                    <div class="flex justify-between items-center p-3 bg-white rounded border ${!block.is_correct ? 'border-red-300' : 'border-green-300'}">
                                        <div>
                                            <div class="font-medium">${block.title}</div>
                                            <div class="text-sm text-gray-600">
                                                –ú–∞–∫—Å. –±–∞–ª–ª—ã: ${block.max_points} |
                                                –í–æ–ø—Ä–æ—Å–æ–≤: ${block.questions_count} |
                                                –°—É–º–º–∞ –±–∞–ª–ª–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤: ${block.total_question_points} |
                                                –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${block.participants_count}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            ${block.is_correct ? '‚úÖ' : '‚ùå'}
                                            <button onclick="diagnoseBlock(${block.id})" class="ml-2 px-2 py-1 bg-blue-500 text-white rounded text-xs">
                                                –î–µ—Ç–∞–ª–∏
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button onclick="fixOlympiadPoints(${olympiadId})" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                                üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –±–∞–ª–ª—ã
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('diagnostic-content').innerHTML = content;
                document.getElementById('diagnostic-modal').classList.remove('hidden');
            } else {
                showMessage('–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –æ–ª–∏–º–ø–∏–∞–¥—ã', 'error');
        });
    }

    function fixBlockPoints(blockId) {
        if (!confirm('–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞?')) {
            return;
        }

        fetch(`/admin/block/${blockId}/fix_points`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('‚úÖ ' + data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showMessage('‚ùå –û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤', 'error');
        });
    }

    function showParticipationDetails(participationId) {
        fetch(`/admin/participation/${participationId}/details`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const content = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>–ò–º—è:</strong> ${data.user_name}</div>
                                <div><strong>Email:</strong> ${data.user_email}</div>
                                <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.status}</div>
                                <div><strong>–ë–∞–ª–ª—ã –∑–∞ –∑–∞–¥–∞–Ω–∏—è:</strong> ${data.total_points}</div>
                                <div><strong>–í—Ä–µ–º–µ–Ω–Ω–æ–π –±–æ–Ω—É—Å:</strong> +${data.time_bonus || 0}</div>
                                <div><strong>–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª:</strong> ${data.final_score}</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –±–ª–æ–∫–∞–º</h4>
                            <div class="space-y-2">
                                ${data.blocks_results.map(block => `
                                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                                        <div>
                                            <div class="font-medium">${block.block_title}</div>
                                            <div class="text-sm text-gray-600">
                                                –û—Ç–≤–µ—Ç–æ–≤: ${block.questions_answered}/${block.total_questions}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-semibold">${block.result_points}/${block.max_points}</div>
                                            <div class="text-xs text-gray-500">
                                                (–ø–æ –æ—Ç–≤–µ—Ç–∞–º: ${block.answers_points})
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('diagnostic-content').innerHTML = content;
                document.getElementById('diagnostic-modal').classList.remove('hidden');
            } else {
                showMessage('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ', 'error');
        });
    }

    function showMessage(message, type = 'info') {
        const colors = {
            success: 'bg-green-100 border-green-500 text-green-700',
            error: 'bg-red-100 border-red-500 text-red-700',
            warning: 'bg-yellow-100 border-yellow-500 text-yellow-700',
            info: 'bg-blue-100 border-blue-500 text-blue-700'
        };

        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 border-l-4 rounded ${colors[type]} max-w-sm`;
        notification.innerHTML = `
            <div class="flex justify-between">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 font-bold">&times;</button>
            </div>
        `;

        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö –æ–±–ª–∞—Å—Ç–∏
    document.addEventListener('click', function(event) {
        const modals = ['add-block-modal', 'diagnostic-modal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && !modal.classList.contains('hidden')) {
                const modalContent = modal.querySelector('.bg-white');
                if (event.target === modal && !modalContent.contains(event.target)) {
                    modal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            }
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –Ω–∞–∂–∞—Ç–∏—é Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modals = ['add-block-modal', 'diagnostic-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            });
        }
    });
</script>
{% endblock %}