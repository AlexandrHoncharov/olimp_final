{% extends "base.html" %}

{% block title %}Редактирование блока - {{ block.title }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('edit_olympiad', olympiad_id=block.olympiad_id) }}" class="text-primary hover:underline">&larr; Вернуться к редактированию олимпиады</a>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h1 class="text-2xl font-bold mb-4">Редактирование блока: {{ block.title }}</h1>

        <div class="flex flex-wrap gap-4 mb-6 text-sm">
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Максимум баллов:</span> {{ block.max_points }}
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Порог прохождения:</span> {{ block.threshold_percentage }}%
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Вопросов:</span> {{ questions|length }}
            </div>
        </div>

        {% if block.description %}
            <div class="mb-6">
                <h2 class="text-lg font-medium mb-2">Описание блока:</h2>
                <p class="text-gray-700">{{ block.description }}</p>
            </div>
        {% endif %}

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Список вопросов</h2>
            <div>
                <button
                    id="batch-upload-button"
                    onclick="showBatchUploadModal()"
                    class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition mr-2"
                >
                    Пакетная загрузка из TXT
                </button>
                <button
                    id="add-test-button"
                    onclick="showAddQuestionModal('test')"
                    class="px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition mr-2"
                >
                    Добавить тестовый вопрос
                </button>
                <button
                    id="add-matching-button"
                    onclick="showAddQuestionModal('matching')"
                    class="px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
                >
                    Добавить вопрос на сопоставление
                </button>
            </div>
        </div>

        {% if questions %}
            <div class="space-y-4">
                {% for question in questions %}
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 p-4 flex justify-between items-center">
                            <div>
                                <h3 class="font-medium">Вопрос {{ loop.index }}: {{ question.text }}</h3>
                                <div class="text-sm text-gray-600">
                                    Тип: {{ 'Тестовый' if question.question_type == 'test' else 'Сопоставление' }},
                                    Баллы: {{ question.points }}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editQuestion('{{ question.id }}', '{{ question.question_type }}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    <i class="fas fa-edit"></i> Изменить
                                </button>
                                <button onclick="confirmDeleteQuestion('{{ question.id }}')" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    <i class="fas fa-trash"></i> Удалить
                                </button>
                            </div>
                        </div>

                        <div class="p-4">
                            {% if question.question_type == 'test' %}
                                {% if question.options_list %}
                                    <div class="mb-2">
                                        <div class="text-sm font-medium">Варианты ответов:</div>
                                        <ul class="list-disc list-inside space-y-1 mt-1">
                                            {% for option in question.options_list %}
                                                <li class="{% if question.correct_answers_list and option in question.correct_answers_list %}font-medium text-green-700{% endif %}">
                                                    {{ option }} {% if question.correct_answers_list and option in question.correct_answers_list %}✓{% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>

                                    <div class="text-sm text-gray-600">
                                        {% if question.correct_answers_list and question.correct_answers_list|length > 1 %}
                                            Вопрос с несколькими правильными ответами
                                        {% else %}
                                            Вопрос с одним правильным ответом
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <p class="text-red-500">Ошибка: не удалось загрузить варианты ответов</p>
                                {% endif %}
                            {% elif question.question_type == 'matching' %}
                                {% if question.matches_data %}
                                    <!-- Новый формат отображения -->
                                    <div class="mb-2">
                                        <div class="text-sm font-medium mb-3">Элементы для сопоставления:</div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                            <div>
                                                <div class="font-medium text-sm mb-2 text-blue-700">Левая колонка ({{ question.matches_data.left_items|length }} элементов):</div>
                                                {% for left_item in question.matches_data.left_items %}
                                                    <div class="p-2 bg-blue-50 rounded mb-1 border border-blue-200">{{ left_item }}</div>
                                                {% endfor %}
                                            </div>
                                            <div>
                                                <div class="font-medium text-sm mb-2 text-green-700">Правая колонка ({{ question.matches_data.right_items|length }} элементов):</div>
                                                {% for right_item in question.matches_data.right_items %}
                                                    <div class="p-2 bg-green-50 rounded mb-1 border border-green-200">{{ right_item }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="mt-4 p-3 bg-gray-50 rounded-lg border">
                                            <div class="font-medium text-sm mb-2 text-gray-700">Правильные соответствия:</div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                {% for left_item, right_item in question.matches_data.correct_matches.items() %}
                                                    <div class="text-sm text-gray-700 bg-white p-2 rounded border flex items-center">
                                                        <span class="font-medium text-blue-700">{{ left_item }}</span>
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span class="font-medium text-green-700">{{ right_item }}</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% elif question.matches_list %}
                                    <!-- Старый формат отображения для обратной совместимости -->
                                    <div class="mb-2">
                                        <div class="text-sm font-medium">Пары для сопоставления (старый формат):</div>
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                            <div class="font-medium">Левая колонка</div>
                                            <div class="font-medium">Правая колонка</div>

                                            {% for match in question.matches_list %}
                                                <div class="p-2 bg-gray-50 rounded">{{ match.left }}</div>
                                                <div class="p-2 bg-gray-50 rounded">{{ match.right }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% else %}
                                    <p class="text-red-500">Ошибка: не удалось загрузить элементы сопоставления</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center p-8 text-gray-500">
                <p>В этом блоке пока нет вопросов</p>
            </div>
        {% endif %}
    </div>

    <!-- Модальное окно для пакетной загрузки вопросов из TXT файла -->
    <div id="batch-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">Пакетная загрузка вопросов из TXT</h3>
                <button onclick="closeBatchUploadModal()" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <form id="batch-upload-form" enctype="multipart/form-data">
                    <div class="space-y-4">
                        <div>
                            <label for="question_type_select" class="block text-sm font-medium text-gray-700 mb-1">Тип загружаемых вопросов</label>
                            <select id="question_type_select" name="question_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="test">Тестовые вопросы</option>
                                <option value="matching">Вопросы на сопоставление</option>
                            </select>
                        </div>

                        <div>
                            <label for="questions_file" class="block text-sm font-medium text-gray-700 mb-1">Файл с вопросами (.txt)</label>
                            <input
                                type="file"
                                id="questions_file"
                                name="questions_file"
                                accept=".txt"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"
                            >
                        </div>

                        <div class="bg-blue-50 p-4 rounded-md">
                            <h4 class="text-sm font-semibold text-blue-700 mb-2">Формат файла для тестовых вопросов:</h4>
                            <pre class="text-xs text-blue-800 whitespace-pre-wrap">1. Текст вопроса
Вариант 1
Вариант 2
    Правильный вариант (с 4 пробелами перед ним)
Вариант 4

2. Следующий вопрос
...и так далее</pre>

                            <h4 class="text-sm font-semibold text-blue-700 mt-3 mb-2">Формат файла для вопросов на сопоставление (обновленный):</h4>
                            <pre class="text-xs text-blue-800 whitespace-pre-wrap">1. Текст вопроса на сопоставление
Левый элемент 1 | Правый элемент 1
Левый элемент 2 | Правый элемент 2
R: Дополнительный правый элемент 3
R: Дополнительный правый элемент 4

2. Следующий вопрос
...и так далее

Примечание: Строки с "R:" добавляют элементы только в правую колонку (отвлекающие варианты)</pre>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                <button onclick="closeBatchUploadModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
                <button onclick="submitBatchUploadForm()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Загрузить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления тестового вопроса -->
    <div id="test-question-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">Добавление тестового вопроса</h3>
                <button onclick="closeQuestionModal('test')" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <form id="add-test-question-form">
                    <input type="hidden" name="question_type" value="test">
                    <div class="space-y-4">
                        <div>
                            <label for="test_text" class="block text-sm font-medium text-gray-700 mb-1">Текст вопроса</label>
                            <textarea id="test_text" name="text" rows="2" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                        </div>

                        <div id="test-options-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Варианты ответов</label>

                            <div id="options-list">
                                <div class="option-item flex mb-2">
                                    <input
                                        type="text"
                                        name="options[]"
                                        placeholder="Вариант ответа"
                                        required
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <label class="flex items-center px-3 bg-gray-100 rounded-md">
                                        <input
                                            type="checkbox"
                                            name="correct_answers[]"
                                            class="mr-1 correct-checkbox"
                                        >
                                        Правильный
                                    </label>
                                    <button
                                        type="button"
                                        onclick="removeOption(this)"
                                        class="ml-2 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div class="option-item flex mb-2">
                                    <input
                                        type="text"
                                        name="options[]"
                                        placeholder="Вариант ответа"
                                        required
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <label class="flex items-center px-3 bg-gray-100 rounded-md">
                                        <input
                                            type="checkbox"
                                            name="correct_answers[]"
                                            class="mr-1 correct-checkbox"
                                        >
                                        Правильный
                                    </label>
                                    <button
                                        type="button"
                                        onclick="removeOption(this)"
                                        class="ml-2 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>

                            <div id="error-message" class="text-red-600 text-sm mb-2 hidden">
                                Пожалуйста, выберите хотя бы один правильный ответ
                            </div>

                            <button
                                type="button"
                                onclick="addOption()"
                                class="mt-1 px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                            >
                                + Добавить вариант
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                <button onclick="closeQuestionModal('test')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
                <button onclick="submitQuestionForm('test')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления вопроса на сопоставление (обновленное) -->
    <div id="matching-question-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="border-b px-6 py-3 flex justify-between items-center sticky top-0 bg-white">
            <h3 class="text-lg font-medium">Добавление вопроса на сопоставление</h3>
            <button onclick="closeQuestionModal('matching')" class="text-gray-400 hover:text-gray-500">&times;</button>
        </div>
        <div class="p-6">
            <form id="add-matching-question-form">
                <input type="hidden" name="question_type" value="matching">
                <div class="space-y-6">
                    <div>
                        <label for="matching_text" class="block text-sm font-medium text-gray-700 mb-1">Текст вопроса</label>
                        <textarea id="matching_text" name="text" rows="2" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                    </div>

                    <!-- Column Count Selector -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Количество колонок</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="column_count" value="2" checked class="mr-2" onchange="toggleColumnCount()">
                                2 колонки (стандартное сопоставление)
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="column_count" value="3" class="mr-2" onchange="toggleColumnCount()">
                                3 колонки (расширенное сопоставление)
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6" id="columns-container">
                        <!-- Левая колонка (всегда видна) -->
                        <div id="left-items-container" class="lg:col-span-4 border border-blue-200 rounded-lg p-4 bg-blue-50">
                            <label class="block text-sm font-medium text-blue-700 mb-3">Левая колонка (элементы для сопоставления)</label>
                            <div id="left-items-list">
                                <div class="left-item-input flex mb-3">
                                    <input
                                        type="text"
                                        name="left_items[]"
                                        placeholder="Элемент для сопоставления"
                                        required
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <div class="match-selects-container">
                                        <select name="match_middle_0" class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-1 match-middle-select min-w-[100px] hidden">
                                            <option value="">Средняя</option>
                                        </select>
                                        <select name="match_right_0" required class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2 match-right-select min-w-[100px]">
                                            <option value="">Правая</option>
                                        </select>
                                    </div>
                                    <button
                                        type="button"
                                        onclick="removeLeftItem(this)"
                                        class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-left-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div class="left-item-input flex mb-3">
                                    <input
                                        type="text"
                                        name="left_items[]"
                                        placeholder="Элемент для сопоставления"
                                        required
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <div class="match-selects-container">
                                        <select name="match_middle_1" class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-1 match-middle-select min-w-[100px] hidden">
                                            <option value="">Средняя</option>
                                        </select>
                                        <select name="match_right_1" required class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2 match-right-select min-w-[100px]">
                                            <option value="">Правая</option>
                                        </select>
                                    </div>
                                    <button
                                        type="button"
                                        onclick="removeLeftItem(this)"
                                        class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-left-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                            <button
                                type="button"
                                onclick="addLeftItem()"
                                class="mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                            >
                                + Добавить элемент
                            </button>
                        </div>

                        <!-- Средняя колонка (скрыта по умолчанию) -->
                        <div id="middle-items-container" class="lg:col-span-4 border border-yellow-200 rounded-lg p-4 bg-yellow-50 hidden">
                            <label class="block text-sm font-medium text-yellow-700 mb-3">Средняя колонка (промежуточные элементы)</label>
                            <div id="middle-items-list">
                                <div class="middle-item-input flex mb-3">
                                    <input
                                        type="text"
                                        name="middle_items[]"
                                        placeholder="Промежуточный элемент"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <button
                                        type="button"
                                        onclick="removeMiddleItem(this)"
                                        class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-middle-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div class="middle-item-input flex mb-3">
                                    <input
                                        type="text"
                                        name="middle_items[]"
                                        placeholder="Промежуточный элемент"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <button
                                        type="button"
                                        onclick="removeMiddleItem(this)"
                                        class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-middle-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                            <button
                                type="button"
                                onclick="addMiddleItem()"
                                class="mt-1 px-3 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200"
                            >
                                + Добавить элемент
                            </button>
                        </div>

                        <!-- Правая колонка -->
                        <div id="right-items-container" class="lg:col-span-4 border border-green-200 rounded-lg p-4 bg-green-50">
                            <label class="block text-sm font-medium text-green-700 mb-3">Правая колонка (варианты ответов)</label>
                            <div id="right-items-list">
                                <div class="right-item-input flex mb-3">
                                    <input
                                        type="text"
                                        name="right_items[]"
                                        placeholder="Вариант ответа"
                                        required
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <button
                                        type="button"
                                        onclick="removeRightItem(this)"
                                        class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-right-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                                <div class="right-item-input flex mb-3">
                                    <input
                                        type="text"
                                        name="right_items[]"
                                        placeholder="Вариант ответа"
                                        required
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2"
                                    >
                                    <button
                                        type="button"
                                        onclick="removeRightItem(this)"
                                        class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-right-button"
                                        disabled
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                            <button
                                type="button"
                                onclick="addRightItem()"
                                class="mt-1 px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200"
                            >
                                + Добавить вариант
                            </button>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <div class="flex">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400 mr-2 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <div class="text-sm text-yellow-800">
                                <strong>Инструкция:</strong>
                                <ul class="mt-2 space-y-1">
                                    <li>• <strong>2 колонки:</strong> Стандартное сопоставление "вопрос → ответ"</li>
                                    <li>• <strong>3 колонки:</strong> Расширенное сопоставление "вопрос → промежуточный элемент → ответ"</li>
                                    <li>• Для каждого элемента левой колонки обязательно выберите соответствующие элементы</li>
                                    <li>• Дополнительные элементы в средней и правой колонках будут отвлекающими вариантами</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg sticky bottom-0">
            <button onclick="closeQuestionModal('matching')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
            <button onclick="submitQuestionForm('matching')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Добавить</button>
        </div>
    </div>
</div>

    <!-- Модальное окно для подтверждения удаления вопроса -->
    <div id="delete-question-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">Подтверждение удаления</h3>
                <button onclick="closeDeleteQuestionModal()" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-gray-700">Вы уверены, что хотите удалить этот вопрос? Это действие нельзя отменить.</p>
                <input type="hidden" id="delete-question-id" value="">
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                <button onclick="closeDeleteQuestionModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
                <button onclick="deleteQuestion()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования тестового вопроса -->
    <div id="edit-test-question-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="border-b px-6 py-3 flex justify-between items-center">
                <h3 class="text-lg font-medium">Редактирование тестового вопроса</h3>
                <button onclick="closeEditQuestionModal('test')" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <form id="edit-test-question-form">
                    <input type="hidden" id="edit-test-question-id" name="question_id" value="">
                    <input type="hidden" name="question_type" value="test">
                    <div class="space-y-4">
                        <div>
                            <label for="edit_test_text" class="block text-sm font-medium text-gray-700 mb-1">Текст вопроса</label>
                            <textarea id="edit_test_text" name="text" rows="2" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                        </div>

                        <div id="edit-test-options-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Варианты ответов</label>

                            <div id="edit-options-list">
                                <!-- Опции будут добавлены динамически через JavaScript -->
                            </div>

                            <div id="edit-error-message" class="text-red-600 text-sm mb-2 hidden">
                                Пожалуйста, выберите хотя бы один правильный ответ
                            </div>

                            <button
                                type="button"
                                onclick="addEditOption()"
                                class="mt-1 px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                            >
                                + Добавить вариант
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
                <button onclick="closeEditQuestionModal('test')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
                <button onclick="updateQuestionForm('test')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования вопроса на сопоставление -->
    <div id="edit-matching-question-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="border-b px-6 py-3 flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-lg font-medium">Редактирование вопроса на сопоставление</h3>
                <button onclick="closeEditQuestionModal('matching')" class="text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="p-6">
                <form id="edit-matching-question-form">
                    <input type="hidden" id="edit-matching-question-id" name="question_id" value="">
                    <input type="hidden" name="question_type" value="matching">
                    <div class="space-y-6">
                        <div>
                            <label for="edit_matching_text" class="block text-sm font-medium text-gray-700 mb-1">Текст вопроса</label>
                            <textarea id="edit_matching_text" name="text" rows="2" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"></textarea>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Левая колонка редактирования -->
                            <div id="edit-left-items-container" class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                                <label class="block text-sm font-medium text-blue-700 mb-3">Левая колонка (элементы для сопоставления)</label>
                                <div id="edit-left-items-list">
                                    <!-- Элементы будут добавлены динамически через JavaScript -->
                                </div>
                                <button
                                    type="button"
                                    onclick="addEditLeftItem()"
                                    class="mt-1 px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                >
                                    + Добавить элемент
                                </button>
                            </div>

                            <!-- Правая колонка редактирования -->
                            <div id="edit-right-items-container" class="border border-green-200 rounded-lg p-4 bg-green-50">
                                <label class="block text-sm font-medium text-green-700 mb-3">Правая колонка (варианты ответов)</label>
                                <div id="edit-right-items-list">
                                    <!-- Элементы будут добавлены динамически через JavaScript -->
                                </div>
                                <button
                                    type="button"
                                    onclick="addEditRightItem()"
                                    class="mt-1 px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200"
                                >
                                    + Добавить вариант
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg sticky bottom-0">
                <button onclick="closeEditQuestionModal('matching')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 mr-2">Отмена</button>
                <button onclick="updateQuestionForm('matching')" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Complete JavaScript for Three-Column Matching Questions Admin Interface

// Variables for tracking indices
let leftItemIndex = 2;
let middleItemIndex = 2;
let rightItemIndex = 2;
let editLeftItemIndex = 0;
let editMiddleItemIndex = 0;
let editRightItemIndex = 0;
let isThreeColumn = false;
let isEditThreeColumn = false;

// ==================== MODAL MANAGEMENT ====================

function updateQuestionForm(type) {
    if (type === 'test') {
        updateTestQuestion();
    } else if (type === 'matching') {
        updateMatchingQuestion();
    }
}

function showAddQuestionModal(type) {
    const modalId = type === 'test' ? 'test-question-modal' : 'matching-question-modal';
    const modal = document.getElementById(modalId);

    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        if (type === 'matching') {
            resetMatchingForm();
            toggleColumnCount(); // Initialize with current selection
            updateMatchSelects();
            updateRemoveButtons();
        }
    }
}

function closeQuestionModal(type) {
    const modalId = type === 'test' ? 'test-question-modal' : 'matching-question-modal';
    const modal = document.getElementById(modalId);

    if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');

        if (type === 'matching') {
            resetMatchingForm();
        }
    }
}

// ==================== COLUMN COUNT TOGGLE ====================

function toggleColumnCount() {
    const columnCount = document.querySelector('input[name="column_count"]:checked').value;
    isThreeColumn = columnCount === '3';

    const middleContainer = document.getElementById('middle-items-container');
    const leftContainer = document.getElementById('left-items-container');
    const rightContainer = document.getElementById('right-items-container');

    if (isThreeColumn) {
        // Show middle column
        middleContainer.classList.remove('hidden');

        // Show middle selects and make them required
        document.querySelectorAll('.match-middle-select').forEach(select => {
            select.classList.remove('hidden');
            select.required = true;
        });

        // Make middle items required (at least one)
        const middleInputs = document.querySelectorAll('input[name="middle_items[]"]');
        middleInputs.forEach(input => {
            input.addEventListener('input', validateMiddleItems);
        });
    } else {
        // Hide middle column
        middleContainer.classList.add('hidden');

        // Hide middle selects and make them not required
        document.querySelectorAll('.match-middle-select').forEach(select => {
            select.classList.add('hidden');
            select.required = false;
            select.value = '';
        });

        // Clear middle items and remove validation
        document.querySelectorAll('input[name="middle_items[]"]').forEach(input => {
            input.value = '';
            input.removeEventListener('input', validateMiddleItems);
        });
    }

    updateMatchSelects();
    updateRemoveButtons();
}

function validateMiddleItems() {
    if (!isThreeColumn) return true;

    const middleInputs = document.querySelectorAll('input[name="middle_items[]"]');
    const hasMiddleContent = Array.from(middleInputs).some(input => input.value.trim());

    if (!hasMiddleContent) {
        showMessage('При использовании 3 колонок необходимо заполнить хотя бы одну среднюю колонку', 'error');
        return false;
    }
    return true;
}

// ==================== FORM RESET ====================

function resetMatchingForm() {
    // Reset column count to 2
    document.querySelector('input[name="column_count"][value="2"]').checked = true;
    isThreeColumn = false;

    // Hide middle column
    const middleContainer = document.getElementById('middle-items-container');
    middleContainer.classList.add('hidden');

    // Reset left items
    const leftItemsList = document.getElementById('left-items-list');
    leftItemsList.innerHTML = createInitialLeftItems();

    // Reset middle items
    const middleItemsList = document.getElementById('middle-items-list');
    middleItemsList.innerHTML = createInitialMiddleItems();

    // Reset right items
    const rightItemsList = document.getElementById('right-items-list');
    rightItemsList.innerHTML = createInitialRightItems();

    // Reset indices
    leftItemIndex = 2;
    middleItemIndex = 2;
    rightItemIndex = 2;

    // Clear question text
    document.getElementById('matching_text').value = '';
}

function createInitialLeftItems() {
    return `
        <div class="left-item-input flex mb-3">
            <input type="text" name="left_items[]" placeholder="Элемент для сопоставления" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
            <div class="match-selects-container">
                <select name="match_middle_0" class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-1 match-middle-select min-w-[100px] hidden">
                    <option value="">Средняя</option>
                </select>
                <select name="match_right_0" required class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2 match-right-select min-w-[100px]">
                    <option value="">Правая</option>
                </select>
            </div>
            <button type="button" onclick="removeLeftItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-left-button" disabled>✕</button>
        </div>
        <div class="left-item-input flex mb-3">
            <input type="text" name="left_items[]" placeholder="Элемент для сопоставления" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
            <div class="match-selects-container">
                <select name="match_middle_1" class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-1 match-middle-select min-w-[100px] hidden">
                    <option value="">Средняя</option>
                </select>
                <select name="match_right_1" required class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2 match-right-select min-w-[100px]">
                    <option value="">Правая</option>
                </select>
            </div>
            <button type="button" onclick="removeLeftItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-left-button" disabled>✕</button>
        </div>
    `;
}

function createInitialMiddleItems() {
    return `
        <div class="middle-item-input flex mb-3">
            <input type="text" name="middle_items[]" placeholder="Промежуточный элемент" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
            <button type="button" onclick="removeMiddleItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-middle-button" disabled>✕</button>
        </div>
        <div class="middle-item-input flex mb-3">
            <input type="text" name="middle_items[]" placeholder="Промежуточный элемент" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
            <button type="button" onclick="removeMiddleItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-middle-button" disabled>✕</button>
        </div>
    `;
}

function createInitialRightItems() {
    return `
        <div class="right-item-input flex mb-3">
            <input type="text" name="right_items[]" placeholder="Вариант ответа" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
            <button type="button" onclick="removeRightItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-right-button" disabled>✕</button>
        </div>
        <div class="right-item-input flex mb-3">
            <input type="text" name="right_items[]" placeholder="Вариант ответа" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
            <button type="button" onclick="removeRightItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-right-button" disabled>✕</button>
        </div>
    `;
}

// ==================== ADD/REMOVE FUNCTIONS ====================

// Left Items Functions
function addLeftItem() {
    const leftItemsList = document.getElementById('left-items-list');
    const newLeftItem = document.createElement('div');
    newLeftItem.className = 'left-item-input flex mb-3';
    newLeftItem.innerHTML = `
        <input type="text" name="left_items[]" placeholder="Элемент для сопоставления" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
        <div class="match-selects-container">
            <select name="match_middle_${leftItemIndex}" class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-1 match-middle-select min-w-[100px] ${isThreeColumn ? '' : 'hidden'}" ${isThreeColumn ? 'required' : ''}>
                <option value="">Средняя</option>
            </select>
            <select name="match_right_${leftItemIndex}" required class="px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2 match-right-select min-w-[100px]">
                <option value="">Правая</option>
            </select>
        </div>
        <button type="button" onclick="removeLeftItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-left-button">✕</button>
    `;

    leftItemsList.appendChild(newLeftItem);
    leftItemIndex++;
    updateMatchSelects();
    updateRemoveButtons();
}

function removeLeftItem(button) {
    const leftItem = button.closest('.left-item-input');
    leftItem.remove();
    updateMatchSelects();
    updateRemoveButtons();
}

// Middle Items Functions
function addMiddleItem() {
    const middleItemsList = document.getElementById('middle-items-list');
    const newMiddleItem = document.createElement('div');
    newMiddleItem.className = 'middle-item-input flex mb-3';
    newMiddleItem.innerHTML = `
        <input type="text" name="middle_items[]" placeholder="Промежуточный элемент" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
        <button type="button" onclick="removeMiddleItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-middle-button">✕</button>
    `;

    middleItemsList.appendChild(newMiddleItem);
    middleItemIndex++;
    updateMatchSelects();
    updateRemoveButtons();
}

function removeMiddleItem(button) {
    const middleItem = button.closest('.middle-item-input');
    middleItem.remove();
    updateMatchSelects();
    updateRemoveButtons();
}

// Right Items Functions
function addRightItem() {
    const rightItemsList = document.getElementById('right-items-list');
    const newRightItem = document.createElement('div');
    newRightItem.className = 'right-item-input flex mb-3';
    newRightItem.innerHTML = `
        <input type="text" name="right_items[]" placeholder="Вариант ответа" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mr-2">
        <button type="button" onclick="removeRightItem(this)" class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 remove-right-button">✕</button>
    `;

    rightItemsList.appendChild(newRightItem);
    rightItemIndex++;
    updateMatchSelects();
    updateRemoveButtons();
}

function removeRightItem(button) {
    const rightItem = button.closest('.right-item-input');
    rightItem.remove();
    updateMatchSelects();
    updateRemoveButtons();
}

// ==================== UPDATE FUNCTIONS ====================

function updateMatchSelects() {
    const middleInputs = document.querySelectorAll('#middle-items-list input[name="middle_items[]"]');
    const rightInputs = document.querySelectorAll('#right-items-list input[name="right_items[]"]');
    const middleSelects = document.querySelectorAll('.match-middle-select');
    const rightSelects = document.querySelectorAll('.match-right-select');

    // Update middle selects
    middleSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Средняя</option>';

        middleInputs.forEach((input, index) => {
            if (input.value.trim()) {
                const option = document.createElement('option');
                option.value = input.value.trim();
                option.textContent = input.value.trim();
                if (option.value === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        });
    });

    // Update right selects
    rightSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Правая</option>';

        rightInputs.forEach((input, index) => {
            if (input.value.trim()) {
                const option = document.createElement('option');
                option.value = input.value.trim();
                option.textContent = input.value.trim();
                if (option.value === currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        });
    });

    // Add event listeners for input changes
    middleInputs.forEach(input => {
        input.removeEventListener('input', updateMatchSelects);
        input.addEventListener('input', updateMatchSelects);
    });

    rightInputs.forEach(input => {
        input.removeEventListener('input', updateMatchSelects);
        input.addEventListener('input', updateMatchSelects);
    });
}

function updateRemoveButtons() {
    const leftItems = document.querySelectorAll('#left-items-list .left-item-input');
    const middleItems = document.querySelectorAll('#middle-items-list .middle-item-input');
    const rightItems = document.querySelectorAll('#right-items-list .right-item-input');

    const leftRemoveButtons = document.querySelectorAll('.remove-left-button');
    const middleRemoveButtons = document.querySelectorAll('.remove-middle-button');
    const rightRemoveButtons = document.querySelectorAll('.remove-right-button');

    // For left items - minimum 1
    leftRemoveButtons.forEach(button => {
        button.disabled = leftItems.length <= 1;
    });

    // For middle items - minimum 1 when in 3-column mode
    middleRemoveButtons.forEach(button => {
        button.disabled = middleItems.length <= 1;
    });

    // For right items - minimum 1
    rightRemoveButtons.forEach(button => {
        button.disabled = rightItems.length <= 1;
    });
}

// ==================== FORM SUBMISSION ====================

function submitQuestionForm(type) {
    if (type === 'test') {
        submitTestQuestion();
    } else if (type === 'matching') {
        submitMatchingQuestion();
    }
}

function submitTestQuestion() {
    const form = document.getElementById('add-test-question-form');
    if (!form) return;

    // Создаем FormData для отправки
    const formData = new FormData();

    // Добавляем тип вопроса и текст
    formData.append('question_type', 'test');
    formData.append('text', document.getElementById('test_text').value);

    // Собираем варианты ответов и правильные ответы
    const optionItems = document.querySelectorAll('#options-list .option-item');
    const options = [];
    const correctAnswers = [];

    optionItems.forEach((item) => {
        const optionInput = item.querySelector('input[name="options[]"]');
        const correctCheckbox = item.querySelector('input[name="correct_answers[]"]');

        const optionText = optionInput.value.trim();
        if (optionText) {
            options.push(optionText);
            formData.append('options[]', optionText);

            // Если чекбокс отмечен, добавляем текст варианта в правильные ответы
            if (correctCheckbox.checked) {
                correctAnswers.push(optionText);
                formData.append('correct_answers[]', optionText);
            }
        }
    });

    // Валидация
    if (options.length < 2) {
        showMessage('Необходимо указать хотя бы два варианта ответа', 'error');
        return;
    }

    if (correctAnswers.length === 0) {
        document.getElementById('error-message').classList.remove('hidden');
        return;
    } else {
        document.getElementById('error-message').classList.add('hidden');
    }

    console.log('Отправляемые данные:');
    console.log('Варианты:', options);
    console.log('Правильные ответы:', correctAnswers);

    submitFormData(formData, 'Добавление...');
}

function updateTestQuestion() {
    const form = document.getElementById('edit-test-question-form');
    if (!form) return;

    const formData = new FormData();

    // Добавляем ID вопроса и основные данные
    formData.append('question_id', document.getElementById('edit-test-question-id').value);
    formData.append('question_type', 'test');
    formData.append('text', document.getElementById('edit_test_text').value);

    // Собираем варианты ответов и правильные ответы для редактирования
    const optionItems = document.querySelectorAll('#edit-options-list .option-item');
    const options = [];
    const correctAnswers = [];

    optionItems.forEach((item) => {
        const optionInput = item.querySelector('input[name="options[]"]');
        const correctCheckbox = item.querySelector('input[name="correct_answers[]"]');

        const optionText = optionInput.value.trim();
        if (optionText) {
            options.push(optionText);
            formData.append('options[]', optionText);

            // Если чекбокс отмечен, добавляем текст варианта в правильные ответы
            if (correctCheckbox.checked) {
                correctAnswers.push(optionText);
                formData.append('correct_answers[]', optionText);
            }
        }
    });

    // Валидация
    if (options.length < 2) {
        showMessage('Необходимо указать хотя бы два варианта ответа', 'error');
        return;
    }

    if (correctAnswers.length === 0) {
        document.getElementById('edit-error-message').classList.remove('hidden');
        return;
    } else {
        document.getElementById('edit-error-message').classList.add('hidden');
    }

    console.log('Обновляемые данные:');
    console.log('Варианты:', options);
    console.log('Правильные ответы:', correctAnswers);

    // Отправляем на сервер
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = `<svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Сохранение...`;
    submitBtn.disabled = true;

    axios.post(window.location.pathname.replace('/edit', '/update_question'), formData)
        .then(function(response) {
            if (response.data.success) {
                showMessage('Вопрос успешно обновлен!');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showMessage(response.data.message || 'Ошибка при обновлении вопроса', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(function(error) {
            showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
}

function submitMatchingQuestion() {
    const form = document.getElementById('add-matching-question-form');
    if (!form) return;

    // Validate three-column middle items if needed
    if (isThreeColumn && !validateMiddleItems()) {
        return;
    }

    const formData = new FormData(form);

    // Validate that all left items have required matches
    const leftItems = document.querySelectorAll('#left-items-list input[name="left_items[]"]');
    const rightSelects = document.querySelectorAll('.match-right-select');
    const middleSelects = document.querySelectorAll('.match-middle-select');

    let hasErrors = false;
    leftItems.forEach((input, index) => {
        if (input.value.trim()) {
            // Check right select
            if (rightSelects[index] && !rightSelects[index].value) {
                hasErrors = true;
                rightSelects[index].classList.add('border-red-500');
            } else if (rightSelects[index]) {
                rightSelects[index].classList.remove('border-red-500');
            }

            // Check middle select if in 3-column mode
            if (isThreeColumn && middleSelects[index] && !middleSelects[index].value) {
                hasErrors = true;
                middleSelects[index].classList.add('border-red-500');
            } else if (middleSelects[index]) {
                middleSelects[index].classList.remove('border-red-500');
            }
        }
    });

    if (hasErrors) {
        showMessage('Пожалуйста, выберите соответствие для всех элементов левой колонки', 'error');
        return;
    }

    submitFormData(formData, 'Добавление...');
}

function submitFormData(formData, loadingText) {
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = `<svg class="animate-spin h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${loadingText}`;
    submitBtn.disabled = true;

    axios.post(window.location.pathname.replace('/edit', '/add_question'), formData)
        .then(function(response) {
            if (response.data.success) {
                showMessage('Вопрос успешно добавлен!');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showMessage(response.data.message || 'Ошибка при добавлении вопроса', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(function(error) {
            showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
}

// ==================== EDIT FUNCTIONS ====================

function editQuestion(questionId, questionType) {
    // Get question data via API
    axios.get(`${window.location.pathname}/get_question?question_id=${questionId}`)
        .then(function(response) {
            if (response.data.success) {
                currentQuestionData = response.data.question;

                if (questionType === 'test') {
                    showEditTestQuestion(currentQuestionData);
                } else {
                    showEditMatchingQuestion(currentQuestionData);
                }
            } else {
                showMessage(response.data.message || 'Ошибка при получении данных вопроса', 'error');
            }
        })
        .catch(function(error) {
            showMessage('Произошла ошибка: ' + (error.response?.data?.message || error.message), 'error');
        });
}

function showEditMatchingQuestion(question) {
    // Fill form with question data
    document.getElementById('edit-matching-question-id').value = question.id;
    document.getElementById('edit_matching_text').value = question.text;

    // Clear existing elements
    const leftItemsList = document.getElementById('edit-left-items-list');
    const middleItemsList = document.getElementById('edit-middle-items-list');
    const rightItemsList = document.getElementById('edit-right-items-list');
    leftItemsList.innerHTML = '';
    middleItemsList.innerHTML = '';
    rightItemsList.innerHTML = '';

    // Reset indices for editing
    editLeftItemIndex = 0;
    editMiddleItemIndex = 0;
    editRightItemIndex = 0;

    try {
        let matchesData;
        if (question.matches_data && typeof question.matches_data === 'object') {
            matchesData = question.matches_data;
        } else {
            matchesData = JSON.parse(question.matches);
        }

        // Determine if this is a 3-column question
        isEditThreeColumn = matchesData.columns === 3 || (matchesData.middle_items && matchesData.middle_items.length > 0);

        // Set column count
        if (isEditThreeColumn) {
            document.querySelector('input[name="edit_column_count"][value="3"]').checked = true;
        } else {
            document.querySelector('input[name="edit_column_count"][value="2"]').checked = true;
        }
        toggleEditColumnCount();

        // Add right items first
        if (matchesData.right_items) {
            matchesData.right_items.forEach(rightItem => {
                addEditRightItemWithValue(rightItem);
            });
        }

        // Add middle items if available
        if (matchesData.middle_items && matchesData.middle_items.length > 0) {
            matchesData.middle_items.forEach(middleItem => {
                addEditMiddleItemWithValue(middleItem);
            });
        }

        // Add left items with matches
        if (matchesData.left_items) {
            matchesData.left_items.forEach(leftItem => {
                const correctMatch = matchesData.correct_matches[leftItem];
                const middleValue = correctMatch && correctMatch.middle ? correctMatch.middle : '';
                const rightValue = correctMatch && correctMatch.right ? correctMatch.right : '';
                addEditLeftItemWithValue(leftItem, middleValue, rightValue);
            });
        }

    } catch (error) {
        console.error('Error parsing question data:', error);
    }

    // Update selects and buttons
    updateEditMatchSelects();
    updateEditRemoveButtons();

    // Show modal
    const modal = document.getElementById('edit-matching-question-modal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

// ==================== BATCH UPLOAD ====================

function showBatchUploadModal() {
    const modal = document.getElementById('batch-upload-modal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
}

function closeBatchUploadModal() {
    const modal = document.getElementById('batch-upload-modal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
}

function submitBatchUploadForm() {
    const form = document.getElementById('batch-upload-form');
    if (!form) return;

    const formData = new FormData(form);

    // Check if file is selected
    const fileInput = document.getElementById('questions_file');
    if (!fileInput.files || fileInput.files.length === 0) {
        showMessage('Пожалуйста, выберите файл для загрузки', 'error');
        return;
    }

    const submitBtn = event.target;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Загрузка...';
    submitBtn.disabled = true;

    // ИСПРАВЛЕНО: убираем /edit из URL
    const currentPath = window.location.pathname;
    const blockId = currentPath.match(/\/admin\/block\/(\d+)\/edit/)[1];
    const uploadUrl = `/admin/block/${blockId}/upload_questions`;

    axios.post(uploadUrl, formData)
        .then(function(response) {
            if (response.data.success) {
                const addedCount = response.data.questions_count || 0;
                showMessage(`Успешно загружено ${addedCount} вопросов!`);
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showMessage(response.data.message || 'Ошибка при загрузке вопросов', 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(function(error) {
            let errorMessage = 'Произошла ошибка при загрузке';
            if (error.response && error.response.data && error.response.data.message) {
                errorMessage = error.response.data.message;
            }
            showMessage(errorMessage, 'error');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
}


// ==================== UTILITY FUNCTIONS ====================

function showMessage(message, type = 'success') {
    let notificationContainer = document.getElementById('notification-container');

    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        notificationContainer.className = 'fixed top-4 right-4 z-50 max-w-md';
        document.body.appendChild(notificationContainer);
    }

    const notification = document.createElement('div');
    const bgClass = type === 'success' ? 'bg-green-50 border-l-4 border-green-500 text-green-700' :
                   'bg-red-50 border-l-4 border-red-500 text-red-700';

    notification.className = `rounded-lg shadow-md p-4 mb-3 ${bgClass}`;
    notification.innerHTML = `
        <div class="flex justify-between">
            <p>${message}</p>
            <button class="ml-4 text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;

    notificationContainer.appendChild(notification);

    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// ==================== EVENT LISTENERS ====================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize remove buttons state
    updateRemoveButtons();

    // Add column count change listeners
    document.querySelectorAll('input[name="column_count"]').forEach(radio => {
        radio.addEventListener('change', toggleColumnCount);
    });

    // Close modals on click outside
    document.addEventListener('click', function(event) {
        const modals = [
            'test-question-modal',
            'matching-question-modal',
            'batch-upload-modal',
            'delete-question-modal',
            'edit-test-question-modal',
            'edit-matching-question-modal'
        ];

        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && !modal.classList.contains('hidden')) {
                const modalContent = modal.querySelector('.bg-white');
                if (event.target === modal && !modalContent.contains(event.target)) {
                    modal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            }
        });
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modals = [
                'test-question-modal',
                'matching-question-modal',
                'batch-upload-modal',
                'delete-question-modal',
                'edit-test-question-modal',
                'edit-matching-question-modal'
            ];

            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            });
        }
    });
});

// ==================== UPDATED FILE FORMAT INFO ====================

const UPDATED_QUESTION_FILE_FORMAT = `
Формат файла для тестовых вопросов:
1. Название вопроса
Вариант ответа 1
Вариант ответа 2
    Правильный вариант ответа (начинается с 4 пробелов)
Вариант ответа 4

Формат файла для вопросов на сопоставление (2 колонки):
1. Название вопроса на сопоставление
Левая часть 1 | Правая часть 1
Левая часть 2 | Правая часть 2
R: Дополнительная правая часть 3

Формат файла для вопросов на сопоставление (3 колонки):
1. Название вопроса на сопоставление
Левая часть 1 | Средняя часть 1 | Правая часть 1
Левая часть 2 | Средняя часть 2 | Правая часть 2
M: Дополнительная средняя часть 3
R: Дополнительная правая часть 3

Примечание: Строки с "M:" добавляют элементы только в среднюю колонку (отвлекающие варианты)
Строки с "R:" добавляют элементы только в правую колонку (отвлекающие варианты)
`;

// Function to get updated file format
function getQuestionFileFormat() {
    return UPDATED_QUESTION_FILE_FORMAT;
}
</script>
{% endblock %}