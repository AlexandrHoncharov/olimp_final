<!-- admin/rankings.html -->
{% extends "base.html" %}

{% block title %}Результаты олимпиады - {{ olympiad.title }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <a href="{{ url_for('edit_olympiad', olympiad_id=olympiad.id) }}" class="text-primary hover:underline">&larr; Вернуться к редактированию олимпиады</a>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Результаты олимпиады: {{ olympiad.title }}</h1>
            <a
                href="{{ url_for('export_rankings_pdf', olympiad_id=olympiad.id) }}"
                class="inline-block px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition"
            >
                Экспорт в PDF
            </a>
        </div>

        <div class="flex flex-wrap gap-4 mb-6 text-sm">
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Дата начала:</span> {{ olympiad.start_time.strftime('%d.%m.%Y %H:%M') }}
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Дата окончания:</span> {{ olympiad.end_time.strftime('%d.%m.%Y %H:%M') }}
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Всего участников:</span> {{ participations|length }}
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full">
                <span class="font-medium">Завершили:</span> {{ participations|selectattr('status', 'equalto', 'completed')|list|length }}
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Место</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ФИО</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Группа</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Баллы</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Начало</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Завершение</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время (мин)</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for p in participations %}
                        {% if p.status == 'completed' %}
                            {% set user = users[p.user_id] %}
                            {% set duration = ((p.finish_time - p.start_time).total_seconds() / 60) if p.finish_time and p.start_time else None %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">{{ loop.index }}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium">{{ user.full_name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">{{ user.study_group }}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium">{{ p.total_points }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    {% if p.start_time %}
                                        {{ p.start_time.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    {% if p.finish_time %}
                                        {{ p.finish_time.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    {% if duration %}
                                        {{ "%.1f"|format(duration) }}
                                    {% else %}
                                        -
                                    {% endif %}