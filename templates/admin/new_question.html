<!-- templates/admin/new_question.html -->
{% extends "base.html" %}

{% block title %}Новый вопрос - {{ block.title }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('admin.manage_block', block_id=block.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Назад к блоку
    </a>
</div>

<h2 class="mb-4">Добавление вопроса в блок "{{ block.title }}"</h2>

<form id="question-form" method="POST">
    {{ form.hidden_tag() }}

    <div class="card mb-4 shadow">
        <div class="card-body">
            <div class="mb-3">
                {{ form.question_text.label(class="form-label") }}
                {{ form.question_text(class="form-control", rows=3) }}
                {% if form.question_text.errors %}
                    <div class="text-danger">
                        {% for error in form.question_text.errors %}
                            <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.question_type.label(class="form-label") }}
                {{ form.question_type(class="form-select") }}
                {% if form.question_type.errors %}
                    <div class="text-danger">
                        {% for error in form.question_type.errors %}
                            <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.points.label(class="form-label") }}
                {{ form.points(class="form-control") }}
                {% if form.points.errors %}
                    <div class="text-danger">
                        {% for error in form.points.errors %}
                            <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Динамические формы в зависимости от типа вопроса -->
    <div id="test-options" class="card mb-4 shadow d-none">
        <div class="card-header">
            <h5 class="mb-0">Варианты ответов</h5>
        </div>
        <div class="card-body">
            <div id="test-options-container">
                <!-- Сюда будут добавляться поля для вариантов ответов -->
            </div>

            <button type="button" id="add-test-option" class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-plus-circle"></i> Добавить вариант ответа
            </button>
        </div>
    </div>

    <div id="matching-options" class="card mb-4 shadow d-none">
        <div class="card-header">
            <h5 class="mb-0">Пары для соответствия</h5>
        </div>
        <div class="card-body">
            <div id="matching-pairs-container">
                <!-- Сюда будут добавляться поля для пар соответствия -->
            </div>

            <button type="button" id="add-matching-pair" class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-plus-circle"></i> Добавить пару
            </button>
        </div>
    </div>

    <div class="d-grid">
        <button type="submit" class="btn btn-primary btn-lg">Сохранить вопрос</button>
    </div>

    {{ form.options }}
    {{ form.matching_pairs }}
</form>
{% endblock %}

{% block scripts %}
<script>
    // Переменные для отслеживания данных
    let testOptions = [];
    let matchingPairs = [];
    let nextPairId = 1;

    // Обновление скрытых полей с данными
    function updateHiddenFields() {
        document.getElementById('options').value = JSON.stringify(testOptions);
        document.getElementById('matching_pairs').value = JSON.stringify(matchingPairs);
    }

    // Добавление варианта ответа для тестового вопроса
    function addTestOption() {
        const optionId = 'test-option-' + Date.now();
        const optionsContainer = document.getElementById('test-options-container');

        const newOption = document.createElement('div');
        newOption.className = 'test-option mb-2 row align-items-center';
        newOption.dataset.id = optionId;
        newOption.innerHTML = `
            <div class="col-10">
                <div class="input-group">
                    <span class="input-group-text">
                        <input type="checkbox" class="correct-checkbox">
                    </span>
                    <input type="text" class="form-control option-text" placeholder="Вариант ответа">
                </div>
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-sm btn-outline-danger remove-option">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        optionsContainer.appendChild(newOption);

        // Добавляем вариант в массив
        testOptions.push({
            id: optionId,
            text: '',
            is_correct: false
        });

        // Обновляем скрытое поле
        updateHiddenFields();

        // Добавляем обработчики событий
        const optionTextInput = newOption.querySelector('.option-text');
        const correctCheckbox = newOption.querySelector('.correct-checkbox');
        const removeButton = newOption.querySelector('.remove-option');

        optionTextInput.addEventListener('input', function() {
            const index = testOptions.findIndex(opt => opt.id === optionId);
            if (index !== -1) {
                testOptions[index].text = this.value;
                updateHiddenFields();
            }
        });

        correctCheckbox.addEventListener('change', function() {
            const index = testOptions.findIndex(opt => opt.id === optionId);
            if (index !== -1) {
                testOptions[index].is_correct = this.checked;
                updateHiddenFields();
            }
        });

        removeButton.addEventListener('click', function() {
            newOption.remove();
            testOptions = testOptions.filter(opt => opt.id !== optionId);
            updateHiddenFields();
        });
    }

    // Добавление пары для задания на соответствие
    function addMatchingPair() {
        const pairContainer = document.getElementById('matching-pairs-container');

        const newPair = document.createElement('div');
        newPair.className = 'matching-pair mb-3 row';
        newPair.dataset.id = nextPairId;
        newPair.innerHTML = `
            <div class="col-5">
                <input type="text" class="form-control left-item" placeholder="Левый элемент">
            </div>
            <div class="col-5">
                <input type="text" class="form-control right-item" placeholder="Правый элемент">
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-sm btn-outline-danger remove-pair">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        pairContainer.appendChild(newPair);

        // Добавляем пару в массив
        matchingPairs.push({
            pair_id: nextPairId,
            left: '',
            right: ''
        });

        // Обновляем скрытое поле
        updateHiddenFields();

        // Добавляем обработчики событий
        const leftInput = newPair.querySelector('.left-item');
        const rightInput = newPair.querySelector('.right-item');
        const removeButton = newPair.querySelector('.remove-pair');

        leftInput.addEventListener('input', function() {
            const index = matchingPairs.findIndex(pair => pair.pair_id === nextPairId);
            if (index !== -1) {
                matchingPairs[index].left = this.value;
                updateHiddenFields();
            }
        });

        rightInput.addEventListener('input', function() {
            const index = matchingPairs.findIndex(pair => pair.pair_id === nextPairId);
            if (index !== -1) {
                matchingPairs[index].right = this.value;
                updateHiddenFields();
            }
        });

        removeButton.addEventListener('click', function() {
            newPair.remove();
            matchingPairs = matchingPairs.filter(pair => pair.pair_id !== nextPairId);
            updateHiddenFields();
        });

        nextPairId++;
    }

    // Обновление формы в зависимости от выбранного типа вопроса
    function updateFormByQuestionType() {
        const questionType = document.getElementById('question_type').value;
        const testOptionsDiv = document.getElementById('test-options');
        const matchingOptionsDiv = document.getElementById('matching-options');

        if (questionType === 'test') {
            testOptionsDiv.classList.remove('d-none');
            matchingOptionsDiv.classList.add('d-none');
            if (testOptions.length === 0) {
                // Добавляем два варианта ответа по умолчанию
                addTestOption();
                addTestOption();
            }
        } else if (questionType === 'matching') {
            testOptionsDiv.classList.add('d-none');
            matchingOptionsDiv.classList.remove('d-none');
            if (matchingPairs.length === 0) {
                // Добавляем две пары по умолчанию
                addMatchingPair();
                addMatchingPair();
            }
        } else {
            testOptionsDiv.classList.add('d-none');
            matchingOptionsDiv.classList.add('d-none');
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация формы
        updateFormByQuestionType();

        // Обработчик изменения типа вопроса
        document.getElementById('question_type').addEventListener('change', updateFormByQuestionType);

        // Обработчики для кнопок добавления
        document.getElementById('add-test-option').addEventListener('click', addTestOption);
        document.getElementById('add-matching-pair').addEventListener('click', addMatchingPair);

        // Обработчик отправки формы
        document.getElementById('question-form').addEventListener('submit', function(event) {
            const questionType = document.getElementById('question_type').value;

            if (questionType === 'test' && testOptions.length === 0) {
                event.preventDefault();
                alert('Добавьте хотя бы один вариант ответа!');
                return;
            }

            if (questionType === 'test' && !testOptions.some(opt => opt.is_correct)) {
                event.preventDefault();
                alert('Отметьте хотя бы один правильный вариант ответа!');
                return;
            }

            if (questionType === 'matching' && matchingPairs.length === 0) {
                event.preventDefault();
                alert('Добавьте хотя бы одну пару для соответствия!');
                return;
            }

            // Обновляем скрытые поля перед отправкой
            updateHiddenFields();
        });
    });
</script>
{% endblock %}